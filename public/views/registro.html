<!DOCTYPE html>
<html lang="es">
<head>
    <title>Registro de Usuario</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/registro.css">
    <!-- Aseguramos que el archivo bootstrap-icons.css se cargue -->
    <link rel="stylesheet" href="../css/bootstrap-icons.css">
    <!-- Font Awesome para los iconos de usuario y contrase√±a (mantener por si se usa en main.css o en otro lado) -->
    <script src="https://kit.fontawesome.com/a81368914c.js" crossorigin="anonymous"></script>
    <style>
                /* üîπ Ajustamos la posici√≥n de los textos de ayuda */
        .help-block {
            font-size: 0.85em;
            margin-top: 4px;
            margin-bottom: 12px;
            color: #666;
        }


    </style>

</head>
<!-- Eliminamos el fondo inline del body para que el CSS defina el background -->
<body >
    <div class="container">
        <!-- Panel Izquierdo: Formulario de Registro -->
        <div class="left-panel-form">
            <h2 class="register-title">Crea una nueva cuenta</h2>
            <form id="registerForm" autocomplete="off" novalidate>
                <!-- Input C√©dula -->
                <div class="form-group label-floating">
                    <input class="form-control" id="cedula" type="text" placeholder="C√©dula" pattern="[0-9]{7,10}" title="La c√©dula debe contener solo n√∫meros (7-10 d√≠gitos)" required oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                    <p class="help-block" style="color: #83e5ec;">Escribe tu C√©dula (solo n√∫meros, 7-10 d√≠gitos)</p>
                </div>
                <!-- Input Nombre Completo -->
                <div class="form-group label-floating">
                    <input class="form-control" id="nombre_completo" type="text" placeholder="Nombre Completo" pattern="[A-Za-z\s√±√ë√°√©√≠√≥√∫√Å√â√ç√ì√ö]+" title="El nombre completo solo debe contener letras y espacios" required oninput="this.value = this.value.replace(/[^A-Za-z\s√±√ë√°√©√≠√≥√∫√Å√â√ç√ì√ö]/g, '');">
                    <p class="help-block" style="color: #83e5ec;">Escribe tu Nombre Completo (solo letras)</p>
                </div>
                <!-- Input Correo -->
                <div class="form-group label-floating">
                    <input class="form-control" id="correo" type="email" placeholder="Correo" required>
                    <p class="help-block" style="color: #83e5ec;">Escribe tu Correo</p>
                </div>
<!-- Input Contrase√±a -->
<div class="form-group label-floating">
    <div class="password-container"> <!-- Contenedor para el input y el ojo -->
        <input class="form-control" id="contrase√±a" type="password" placeholder="Contrase√±a"
            title="La contrase√±a debe tener al menos 7 caracteres, incluyendo una may√∫scula, una min√∫scula, un n√∫mero y un car√°cter especial." required>
        <!-- Icono de ojo para alternar visibilidad -->
        <span class="toggle-password" id="togglePassword">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
        </span>
    </div>
    <p class="help-block" style="margin-top: 4px; margin-bottom: 12px; color: #83e5ec; font-size: 0.75em; padding-bottom: 4px;">
        Escribe tu contrase√±a (m√≠nimo 7 caracteres, May√∫s, min√∫s, n√∫mero, especial)
    </p>
</div>

<!-- Input Confirmar Contrase√±a -->
<div class="form-group label-floating">
    <div class="password-container" style="padding-top: 19px;">
        <input class="form-control" id="confirmar_contrase√±a" type="password" placeholder="Confirmar Contrase√±a" required>
        <span class="toggle-password" id="toggleConfirmarPassword">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
        </span>
    </div>
</div>

                
                <div class="form-group text-center">
                    <input type="submit" value="Registrarse" class="btn btn-raised btn-register">
                </div>
                <div class="register-links">
                    <p><a href="/">¬øYa tienes cuenta? Inicia sesi√≥n</a></p>
                </div>
            </form>
        </div>

        <!-- Panel Derecho: Solo el Logo UNEFA -->
        <div class="right-panel-logo">
            <img src="../assets/img/unefa.png" style="margin-bottom:-25px;" class="unefa-logo-large" alt="Logo UNEFA">
        </div>
    </div>

    <!-- Ventana modal personalizada -->
    <div id="customAlertModal" class="custom-modal-overlay">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <span id="customAlertTitle"></span>
            </div>
            <div class="custom-modal-body">
                <p id="customAlertMessage"></p>
            </div>
            <div class="custom-modal-footer">
                <button id="customAlertOkBtn">Ok</button>
            </div>
        </div>
    </div>

<!--====== Scripts -->
<script src="../js/jquery-3.1.1.min.js"></script>
<script src="../js/bootstrap.min.js"></script>
<script src="../js/material.min.js"></script>
<script src="../js/ripples.min.js"></script>
<script src="../js/jquery.mCustomScrollbar.concat.min.js"></script>
<script src="../js/main.js"></script>
<script>
    $(document).ready(function() {
        $.material.init();

        /** =========================
         *   MODAL ALERTA PERSONALIZADA
         *  ========================= */
        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertTitle = document.getElementById('customAlertTitle');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const customAlertOkBtn = document.getElementById('customAlertOkBtn');

        function showCustomAlert(title, message) {
            customAlertTitle.textContent = title;
            customAlertMessage.textContent = message;
            customAlertModal.style.display = 'flex';

            return new Promise(resolve => {
                const clickHandler = function() {
                    customAlertModal.style.display = 'none';
                    customAlertOkBtn.removeEventListener('click', clickHandler);
                    resolve(true);
                };
                customAlertOkBtn.addEventListener('click', clickHandler);
            });
        }

        window.onclick = function(event) {
            if (event.target == customAlertModal) {
                customAlertModal.style.display = 'none';
            }
        };

        /** =========================
         *   TOGGLE PASSWORDS
         *  ========================= */
                 // L√≥gica para alternar la visibilidad de la contrase√±a
            const togglePassword = document.getElementById('togglePassword');
            const toggleConfirmarPassword = document.getElementById('toggleConfirmarPassword');
            const passwordInput = document.getElementById('contrase√±a');
            const confirmarContrase√±aInput = document.getElementById('confirmar_contrase√±a');

            if (togglePassword && passwordInput) {
                togglePassword.addEventListener('click', function() {
                    // Alternar el tipo de input entre 'password' y 'text'
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);

                    // Cambiar el icono del ojo (ahora un SVG en l√≠nea)
                    const eyeSvg = this.querySelector('svg');
                    // Alterna el path del ojo abierto/cerrado. Este SVG es solo un ejemplo,
                    // tendr√≠as que ajustar los paths reales para un ojo abierto y un ojo cerrado.
                    // Para simplificar, solo rotaremos el ojo o cambiaremos su opacidad como ejemplo.
                    if (type === 'text') {
                        // Si se muestra la contrase√±a, podr√≠as cambiar el SVG o su estilo
                        eyeSvg.style.transform = 'scale(0.8)'; // Ejemplo visual
                        eyeSvg.setAttribute('stroke', '#00aaff'); // Cambiar color si se muestra
                        // O si tienes un SVG de ojo cerrado, reemplazarlo
                        // eyeSvg.innerHTML = '<path ... ojo cerrado ...>';
                    } else {
                        // Si la contrase√±a est√° oculta
                        eyeSvg.style.transform = 'scale(1)';
                        eyeSvg.setAttribute('stroke', 'currentColor'); // Volver al color original
                        // eyeSvg.innerHTML = '<path ... ojo abierto ...>';
                    }
                });
            }

            if(toggleConfirmarPassword && confirmarContrase√±aInput){
                toggleConfirmarPassword.addEventListener('click', function() {
                    // Alternar el tipo de input entre 'password' y 'text'
                    const type = confirmarContrase√±aInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    confirmarContrase√±aInput.setAttribute('type', type);

                    // Cambiar el icono del ojo (ahora un SVG en l√≠nea)
                    const eyeSvg = this.querySelector('svg');
                    // Alterna el path del ojo abierto/cerrado. Este SVG es solo un ejemplo,
                    // tendr√≠as que ajustar los paths reales para un ojo abierto y un ojo cerrado.
                    // Para simplificar, solo rotaremos el ojo o cambiaremos su opacidad como ejemplo.
                    if (type === 'text') {
                        // Si se muestra la contrase√±a, podr√≠as cambiar el SVG o su estilo
                        eyeSvg.style.transform = 'scale(0.8)'; // Ejemplo visual
                        eyeSvg.setAttribute('stroke', '#00aaff'); // Cambiar color si se muestra
                        // O si tienes un SVG de ojo cerrado, reemplazarlo
                        // eyeSvg.innerHTML = '<path ... ojo cerrado ...>';
                    } else {
                        // Si la contrase√±a est√° oculta
                        eyeSvg.style.transform = 'scale(1)';
                        eyeSvg.setAttribute('stroke', 'currentColor'); // Volver al color original
                        // eyeSvg.innerHTML = '<path ... ojo abierto ...>';
                    }
                });
            }



        /** =========================
         *   REGISTRO DE USUARIO
         *  ========================= */
        async function handleRegister(event) {
            event.preventDefault();

            const cedulaInput = document.getElementById('cedula').value.trim();
            const nombreCompletoInput = document.getElementById('nombre_completo').value.trim();
            const correoInput = document.getElementById('correo').value.trim();
            const contrase√±aInput = document.getElementById('contrase√±a').value.trim();
            const confirmarContrase√±aInput = document.getElementById('confirmar_contrase√±a').value.trim();

            // 1. Validar campos vac√≠os
            if (!cedulaInput || !nombreCompletoInput || !correoInput || !contrase√±aInput || !confirmarContrase√±aInput) {
                await showCustomAlert("Alerta", "Por favor, completa todos los campos.");
                return;
            }

            // 2. Validar C√©dula (solo n√∫meros, 7-10 d√≠gitos)
            const cedulaRegex = /^[0-9]{7,10}$/;
            if (!cedulaRegex.test(cedulaInput)) {
                await showCustomAlert("Error de C√©dula", "La c√©dula debe contener solo n√∫meros y tener entre 7 y 10 d√≠gitos.");
                return;
            }

            // 3. Validar Nombre Completo (solo letras y espacios)
            const nombreRegex = /^[A-Za-z\s√±√ë√°√©√≠√≥√∫√Å√â√ç√ì√ö]+$/;
            if (!nombreRegex.test(nombreCompletoInput)) {
                await showCustomAlert("Error de Nombre", "El nombre completo solo debe contener letras y espacios.");
                return;
            }

            // 4. Validar Contrase√±a (m√≠nimo 7 caracteres, 1 may√∫scula, 1 min√∫scula, 1 n√∫mero, 1 especial)
            const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&._-])[A-Za-z\d@$!%*?&._-]{7,}$/;
            if (!passwordRegex.test(contrase√±aInput)) {
                await showCustomAlert("Error de Contrase√±a", "La contrase√±a debe tener al menos 7 caracteres, incluyendo una may√∫scula, una min√∫scula, un n√∫mero y un car√°cter especial (ej. @$!%*?&._-).");
                return;
            }

            // 5. Validar que coincidan las contrase√±as
            if (contrase√±aInput !== confirmarContrase√±aInput) {
                await showCustomAlert("Error de Confirmaci√≥n", "Las contrase√±as no coinciden. Por favor, verifica.");
                return;
            }

            const rol = "Administrador"; // Por defecto

            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        cedula: cedulaInput,
                        nombreCompleto: nombreCompletoInput,
                        correo: correoInput,
                        contrase√±a: contrase√±aInput,
                        rol
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    await showCustomAlert("¬°√âxito!", result.message || "Usuario registrado exitosamente.")
                        .then(() => {
                            window.location.href = '/';
                        });
                } else {
                    await showCustomAlert("Error", result.error || "No se pudo registrar el usuario. Int√©ntalo de nuevo.");
                }
            } catch (error) {
                console.error('Error al conectar con el servidor de registro:', error);
                await showCustomAlert("Error de conexi√≥n", "No se pudo conectar con el servidor. Por favor, int√©ntalo m√°s tarde.");
            }
        }

        const registerForm = document.getElementById('registerForm');
        if (registerForm) {
            registerForm.addEventListener('submit', handleRegister);
        }
    });
</script>
</body>
</html>
