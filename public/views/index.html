<!DOCTYPE html>
<html lang="es">
<head>
	<title>Inicio</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
	<link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/inicio.css">
    <link rel="stylesheet" href="../css/bootstrap-icons.css">
    <!-- Font Awesome ya no es necesario si usamos SVG, pero lo mantenemos por si lo usas en otro lado -->
	<script src="https://kit.fontawesome.com/a81368914c.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="container">
        <!-- Panel Izquierdo: Solo el Logo UNEFA -->
        <div class="left-panel">
            <img src="../assets/img/unefa.png" class="unefa-logo-large" alt="Logo UNEFA">
        </div>

        <!-- Eliminamos el div .separator ya que el borde va en .left-panel -->
        <!-- <div class="separator"></div> -->

        <!-- Panel Derecho: Formulario de Login -->
        <div class="login-form-panel">
            <h2 class="login-title">Iniciar Sesión</h2>
            <form id="loginForm" autocomplete="off" novalidate>
                <!-- Input Correo -->
                <div class="form-group label-floating">
                    <label class="control-label" for="correo">Correo</label>
                    <input class="form-control" id="correo" type="email" required>
                </div>
                <!-- End Input Correo -->

                <!-- Input Contraseña -->
                <div class="form-group label-floating">
                    <div class="password-container"> <!-- Contenedor para el input y el ojo -->
                        <label class="control-label" for="contraseña">Contraseña</label>
                        <input class="form-control" id="contraseña" type="password" required>
                        <!-- Icono de ojo para alternar visibilidad (SVG en línea) -->
                        <span class="toggle-password" id="togglePassword">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </span>
                    </div>
                </div>
                <!-- End Input Contraseña -->

                <div class="login-links">
                    <a href="#">¿Olvidaste tu contraseña?</a>
                </div>

                <button type="submit" class="btn btn-login">Login</button>

                <div class="login-links">
                    <a href="/registro">¿No tienes una cuenta? Regístrate</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Ventana modal personalizada -->
    <div id="customAlertModal" class="custom-modal-overlay">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <span id="customAlertTitle"></span>
            </div>
            <div class="custom-modal-body">
                <p id="customAlertMessage"></p>
            </div>
            <div class="custom-modal-footer">
                <button id="customAlertOkBtn">Ok</button>
            </div>
        </div>
    </div>

	<!--====== Scripts -->
	<script src="../js/jquery-3.1.1.min.js"></script>
	<script src="../js/bootstrap.min.js"></script>
	<script src="../js/material.min.js"></script>
	<script src="../js/ripples.min.js"></script>
	<!-- <script src="../js/sweetalert2.min.js"></script> Eliminado SweetAlert2 -->
	<script src="../js/jquery.mCustomScrollbar.concat.min.js"></script>
	<script src="../js/main.js"></script>
	<script>
        // Envuelve todo el JavaScript personalizado dentro de $(document).ready()
        // Esto asegura que el DOM y todas las librerías (excepto SweetAlert2, que ya no está) estén cargados
        // antes de que tu código intente interactuar con ellas.
		$(document).ready(function() {
            // Inicializa los componentes de Material Design
            $.material.init();

            // Referencias a los elementos de la modal personalizada
            const customAlertModal = document.getElementById('customAlertModal');
            const customAlertTitle = document.getElementById('customAlertTitle');
            const customAlertMessage = document.getElementById('customAlertMessage');
            const customAlertOkBtn = document.getElementById('customAlertOkBtn');

            // Función para mostrar la modal personalizada
            function showCustomAlert(title, message) {
                customAlertTitle.textContent = title;
                customAlertMessage.textContent = message;
                customAlertModal.style.display = 'flex'; // Usamos flex para centrar
            }

            // Función para ocultar la modal personalizada
            customAlertOkBtn.onclick = function() {
                customAlertModal.style.display = 'none';
            };

            // Para cerrar la modal si se hace clic fuera de ella
            window.onclick = function(event) {
                if (event.target == customAlertModal) {
                    customAlertModal.style.display = 'none';
                }
            };

            // Lógica para alternar la visibilidad de la contraseña
            const togglePassword = document.getElementById('togglePassword');
            const passwordInput = document.getElementById('contraseña');

            if (togglePassword && passwordInput) {
                togglePassword.addEventListener('click', function() {
                    // Alternar el tipo de input entre 'password' y 'text'
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    
                    // Cambiar el icono del ojo (ahora un SVG en línea)
                    const eyeSvg = this.querySelector('svg');
                    // Alterna el path del ojo abierto/cerrado. Este SVG es solo un ejemplo,
                    // tendrías que ajustar los paths reales para un ojo abierto y un ojo cerrado.
                    // Para simplificar, solo rotaremos el ojo o cambiaremos su opacidad como ejemplo.
                    if (type === 'text') {
                        // Si se muestra la contraseña, podrías cambiar el SVG o su estilo
                        eyeSvg.style.transform = 'scale(0.8)'; // Ejemplo visual
                        eyeSvg.setAttribute('stroke', '#00aaff'); // Cambiar color si se muestra
                        // O si tienes un SVG de ojo cerrado, reemplazarlo
                        // eyeSvg.innerHTML = '<path ... ojo cerrado ...>';
                    } else {
                        // Si la contraseña está oculta
                        eyeSvg.style.transform = 'scale(1)';
                        eyeSvg.setAttribute('stroke', 'currentColor'); // Volver al color original
                        // eyeSvg.innerHTML = '<path ... ojo abierto ...>';
                    }
                });
            }


            // Función para manejar el inicio de sesión
            async function handleLogin(event) {
                event.preventDefault(); // Prevenir el envío del formulario por defecto

                const correoInput = document.getElementById('correo').value;
                const contraseñaInput = document.getElementById('contraseña').value;

                // Validación básica de campos
                if (!correoInput || !contraseñaInput) {
                    showCustomAlert("Alerta", "Por favor, completa todos los campos.");
                    return;
                }

                const correo = correoInput.trim();
                const contraseña = contraseñaInput.trim();

                try {
                    // Realiza la petición POST a tu API de login
                    // ¡IMPORTANTE!: Cambia 'http://localhost:3001' por la URL de tu backend real
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ correo, contraseña })
                    });

                    const result = await response.json();

                    if (response.ok) { // Si la respuesta HTTP es 200 OK
                        // Inicio de sesión exitoso
                        showCustomAlert("¡Éxito!", result.message || "Inicio de sesión exitoso.");
                        // Usamos un pequeño retardo para que el usuario vea la alerta antes de redirigir
                        setTimeout(() => {
                            // Aquí puedes redirigir al usuario según su rol o a la página principal
                            if (result.user && result.user.rol) {
                                if (result.user.rol === 'Administrador') {
                                    window.location.href = '/home'; // Redirigir al dashboard de administrador
                                } else if (result.user.rol === 'Tutor') {
                                    window.location.href = '/tutor-dashboard'; // Redirigir al dashboard del tutor
                                } else if (result.user.rol === 'Estudiante') {
                                    window.location.href = '/student-dashboard'; // Redirigir al dashboard del estudiante
                                } else {
                                    window.location.href = '/default-dashboard'; // Redirigir a un dashboard por defecto si el rol no coincide
                                }
                            } else {
                                window.location.href = '/home'; // Redirigir por defecto si no hay rol o usuario en la respuesta
                            }
                        }, 1500); // Redirige después de 1.5 segundos
                    } else {
                        // Error en el inicio de sesión (ej. credenciales inválidas, error del servidor)
                        showCustomAlert("Error", result.error || "Error al iniciar sesión. Inténtalo de nuevo.");
                    }
                } catch (error) {
                    console.error('Error al conectar con el servidor de login:', error);
                    showCustomAlert("Error de conexión", "No se pudo conectar con el servidor. Por favor, inténtalo más tarde.");
                }
            }

            // Asigna el manejador de eventos al formulario de login
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
        }); // Cierre de $(document).ready()
	</script>
</body>
</html>
