<!DOCTYPE html>
<html lang="es">
<head>
    <title>Editar Perfil</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/bootstrap-icons.css">
    <script src="https://kit.fontawesome.com/a81368914c.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="../css/editar-perfil.css">
</head>
<body>
    	<!-- SideBar -->
	<section class="full-box cover dashboard-sideBar">
		<div class="full-box dashboard-sideBar-bg btn-menu-dashboard"></div>
		<div class="full-box dashboard-sideBar-ct">
			<!--SideBar Title -->
			<div class="full-box text-uppercase text-center text-titles dashboard-sideBar-title">
				UNEFA <i class="zmdi zmdi-close btn-menu-dashboard visible-xs"></i>
			</div>
			<!-- SideBar User info -->
			<div class="full-box dashboard-sideBar-UserInfo">
				<figure class="full-box">
					<img src="../assets/img/unefa.png" alt="UserIcon">
					<figcaption class="text-center text-titles">juancito007</figcaption>
				</figure>
				<ul class="full-box list-unstyled text-center">
					<li>
						<a href="/editar-perfil">
							<i class="zmdi zmdi-settings"></i>
						</a>
					</li>
					<li>
						<!-- Modificamos el href para que no redirija directamente -->
						<a href="#" class="btn-exit-system" id="logoutBtn">
							<i class="zmdi zmdi-power"></i> <!-- Color del icono de cerrar sesión -->
						</a>
					</li>
				</ul>
			</div>
			<!-- SideBar Menu -->
			<ul class="list-unstyled full-box dashboard-sideBar-Menu">
				<li>
					<a href="/home">
						<i class="zmdi zmdi-view-dashboard zmdi-hc-fw"></i> Dashboard
					</a>
				</li>
				<li>
					<a href="#!" class="btn-sideBar-SubMenu">
						<i class="zmdi zmdi-case zmdi-hc-fw"></i> Administracion <i class="zmdi zmdi-caret-down pull-right"></i>
					</a>
					<ul class="list-unstyled full-box">
						<li>
							<a href="/servicio-comunitario"><i class="zmdi zmdi-accounts"></i> Servicio Comunitario</a>
						</li>
						<li>
							<a href="/trabajo-de-grado"><i class="zmdi zmdi-book zmdi-hc-fw"></i> Trabajo Grado</a>
						</li>
						<li>
							<a href="/proyectos"><i class="zmdi zmdi-graduation-cap zmdi-hc-fw"></i>Proyectos de Investigación</a>
						</li>
						<li>
							<a href="/pasantias"><i class="zmdi zmdi-assignment"></i> Pasantias</a>
						</li>
						<li>
							<a href="/bitacora"><i class="zmdi zmdi-bookmark-outline"></i> Bitácora</a>
						</li>
						<li>
							<a href="/proyectos-eliminados"><i class="zmdi zmdi-delete zmdi-hc-fw"></i> Proyectos Eliminados</a>
						</li>
					</ul>
				</li>
				<li>
					<a href="#!" class="btn-sideBar-SubMenu">
						<i class="zmdi zmdi-account-add zmdi-hc-fw"></i> Users <i class="zmdi zmdi-caret-down pull-right"></i>
					</a>
					<ul class="list-unstyled full-box">
						<li>
							<a href="admin.html"><i class="zmdi zmdi-account zmdi-hc-fw"></i> Admin</a>
						</li>
						<li>
							<a href="teacher.html"><i class="zmdi zmdi-male-alt zmdi-hc-fw"></i> Teacher</a>
						</li>
						<li>
							<a href="student.html"><i class="zmdi zmdi-face zmdi-hc-fw"></i> Student</a>
						</li>
					</ul>
				</li>
			</ul>
		</div>
	</section>
    <!-- Content page-->
	<section class="full-box dashboard-contentPage">
		<!-- NavBar -->
		<nav class="full-box dashboard-Navbar">
			<ul class="full-box list-unstyled text-right">
				<li class="pull-left">
					<a href="#!" class="btn-menu-dashboard"><i class="zmdi zmdi-more-vert"></i></a>
				</li>
			</ul>
            
        </nav>
        <div class="form-container">
            <h2 class="text-center">Editar Perfil</h2>
            <form id="editProfileForm">
                <div class="form-group">
                    <label for="nombre_completo">Nombre Completo</label>
                    <input type="text" class="form-control" id="nombre_completo" name="nombre_completo" required>
                </div>
                <div class="form-group">
                    <label for="correo">Correo Institucional</label>
                    <input type="email" class="form-control" id="correo" name="correo" required>
                </div>
                <div class="form-group">
                    <label for="cedula">Cédula</label>
                    <input type="text" class="form-control" id="cedula" name="cedula" required>
                </div>
                <div class="form-group">
                    <label for="contraseña">Contraseña</label>
                    <input type="password" class="form-control" id="contraseña" name="contraseña"> 
                    <!-- La contraseña ya no es requerida por defecto para la actualización -->
                    <span class="toggle-password" id="togglePassword">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                    </span>
                </div>
                <div class="form-group">
                    <label for="confirmar_contraseña">Confirmar contraseña</label>
                    <input type="password" class="form-control" id="confirmar_contraseña" name="confirmar_contraseña">
                    <span class="toggle-password" id="toggleConfirmarPassword">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                    </span> <!-- La contraseña ya no es requerida por defecto para la actualización -->
                </div>
                <div class="text-center">
                    <button type="submit" class="btn btn-primaria id="saveProfileBtn">Guardar Cambios</button>
                    <a href="/home" class="btn btn-default">Cancelar</a>
                </div>
            </form>
        </div>
    </section>

	<script src="./js/jquery-3.1.1.min.js"></script>
	<script src="./js/bootstrap.min.js"></script>
	<script src="./js/material.min.js"></script>
	<script src="./js/ripples.min.js"></script>
	<script src="./js/jquery.mCustomScrollbar.concat.min.js"></script>
	<script src="./js/main.js"></script>
    <!-- Librerías jsPDF y autoTable (localmente) -->
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        let id_login = null;

        // Paso 1: Obtener el ID del usuario actual de la API que usa la sesión
        try {
            const response = await fetch('/api/current-user-id');
            if (!response.ok) {
                // Si falla, significa que el token no es válido o no existe.
                throw new Error('No autorizado. Por favor, inicie sesión de nuevo.');
            }
            const userData = await response.json();
            id_login = userData.id_login;
        } catch (error) {
            console.error('Error:', error);
            // Mostrar un mensaje de error sin usar alert
            const errorMessage = document.createElement('div');
            errorMessage.className = 'alert alert-danger';
            errorMessage.textContent = 'Error al cargar el ID del perfil. Por favor, inicie sesión de nuevo.';
            document.querySelector('.dashboard-contentPage').prepend(errorMessage);

            // Redirigir al login después de un breve retraso para que el usuario vea el mensaje
            setTimeout(() => {
                window.location.href = '/'; 
            }, 3000);
            return;
        }
        
        if (!id_login) {
            // Mostrar un mensaje de error sin usar alert
            const errorMessage = document.createElement('div');
            errorMessage.className = 'alert alert-danger';
            errorMessage.textContent = 'ID de usuario no encontrado. Vuelva a iniciar sesión.';
            document.querySelector('.dashboard-contentPage').prepend(errorMessage);

            // Redirigir al login después de un breve retraso
            setTimeout(() => {
                window.location.href = '/'; 
            }, 3000);
            return;
        }
    
        const form = document.getElementById('editProfileForm');
        const saveBtn = document.getElementById('saveProfileBtn');
        
        // Función para cargar los datos del usuario en el formulario
        async function loadUserData() {
            try {
                // Ahora usamos el id_login obtenido de la sesión para la petición
                const response = await fetch(`/api/administrador/${id_login}`);
                if (!response.ok) {
                    throw new Error('Error al cargar los datos del usuario.');
                }
                const userData = await response.json();
                
                // Rellenar el formulario con los datos obtenidos
                document.getElementById('nombre_completo').value = userData.nombre_completo;
                document.getElementById('correo').value = userData.correo;
                document.getElementById('cedula').value = userData.cedula;
                // La contraseña no se debe precargar en un campo de texto visible por seguridad.
                // Si se desea permitir al usuario cambiarla, se debe dejar el campo vacío
                // y solo enviar la nueva contraseña si el usuario la introduce.
                // document.getElementById('contraseña').value = userData.login.contraseña; 
    
            } catch (error) {
                console.error('Error:', error);
                // Mostrar un mensaje de error sin usar alert
                const errorMessage = document.createElement('div');
                errorMessage.className = 'alert alert-danger';
                errorMessage.textContent = 'Error al cargar los datos del perfil.';
                document.querySelector('.dashboard-contentPage').prepend(errorMessage);
            }
        }
    
        // Manejar el envío del formulario
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            saveBtn.disabled = true;
    
            const updatedData = {
                nombre_completo: document.getElementById('nombre_completo').value,
                correo: document.getElementById('correo').value,
                cedula: document.getElementById('cedula').value,
                // La contraseña se envía solo si el usuario la ha escrito
                contraseña: document.getElementById('contraseña').value
            };

            // Solo incluye la contraseña en la actualización si el campo no está vacío
            if (updatedData.contraseña === '') {
                delete updatedData.contraseña; // Elimina la propiedad si está vacía para no sobrescribir la existente
            }
    
            try {
                const response = await fetch(`/api/administrador/${id_login}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedData),
                    // Es importante incluir las credenciales para enviar la cookie de sesión
                    credentials: 'include' 
                });
    
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'No se pudo actualizar el perfil.');
                }
                // Mostrar un mensaje de éxito sin usar alert
                const successMessage = document.createElement('div');
                successMessage.className = 'alert alert-success';
                successMessage.textContent = 'Perfil actualizado con éxito.';
                document.querySelector('.dashboard-contentPage').prepend(successMessage);

                // Redirigir después de un breve retraso
                setTimeout(() => {
                    window.location.href = '/home'; 
                }, 2000);
    
            } catch (error) {
                console.error('Error:', error);
                // Mostrar un mensaje de error sin usar alert
                const errorMessage = document.createElement('div');
                errorMessage.className = 'alert alert-danger';
                errorMessage.textContent = error.message;
                document.querySelector('.dashboard-contentPage').prepend(errorMessage);
            } finally {
                saveBtn.disabled = false;
            }
        });
    
        loadUserData();
    });

    // Función para crear un mensaje modal personalizado en lugar de alert
    function showCustomMessage(message, type) {
        const messageContainer = document.createElement('div');
        messageContainer.className = `custom-message-box ${type}`;
        messageContainer.innerHTML = `
            <p>${message}</p>
            <button class="close-message-btn">Cerrar</button>
        `;
        document.body.appendChild(messageContainer);

        messageContainer.querySelector('.close-message-btn').addEventListener('click', () => {
            document.body.removeChild(messageContainer);
        });

        // Estilos para el mensaje modal
        const style = document.createElement('style');
        style.textContent = `
            .custom-message-box {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                z-index: 1000;
                text-align: center;
                max-width: 80%;
                border: 2px solid;
            }
            .custom-message-box.success { border-color: #28a745; color: #28a745; }
            .custom-message-box.danger { border-color: #dc3545; color: #dc3545; }
            .close-message-btn {
                background-color: #007bff;
                color: white;
                border: none;
                padding: 8px 15px;
                border-radius: 5px;
                cursor: pointer;
                margin-top: 15px;
            }
            .close-message-btn:hover {
                background-color: #0056b3;
            }
        `;
        document.head.appendChild(style);
    }
                // Lógica para alternar la visibilidad de la contraseña
            const togglePassword = document.getElementById('togglePassword');
            const toggleConfirmarPassword = document.getElementById('toggleConfirmarPassword');
            const passwordInput = document.getElementById('contraseña');
            const confirmarContraseñaInput = document.getElementById('confirmar_contraseña');

            if (togglePassword && passwordInput) {
                togglePassword.addEventListener('click', function() {
                    // Alternar el tipo de input entre 'password' y 'text'
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);

                    // Cambiar el icono del ojo (ahora un SVG en línea)
                    const eyeSvg = this.querySelector('svg');
                    // Alterna el path del ojo abierto/cerrado. Este SVG es solo un ejemplo,
                    // tendrías que ajustar los paths reales para un ojo abierto y un ojo cerrado.
                    // Para simplificar, solo rotaremos el ojo o cambiaremos su opacidad como ejemplo.
                    if (type === 'text') {
                        // Si se muestra la contraseña, podrías cambiar el SVG o su estilo
                        eyeSvg.style.transform = 'scale(0.8)'; // Ejemplo visual
                        eyeSvg.setAttribute('stroke', '#00aaff'); // Cambiar color si se muestra
                        // O si tienes un SVG de ojo cerrado, reemplazarlo
                        // eyeSvg.innerHTML = '<path ... ojo cerrado ...>';
                    } else {
                        // Si la contraseña está oculta
                        eyeSvg.style.transform = 'scale(1)';
                        eyeSvg.setAttribute('stroke', 'currentColor'); // Volver al color original
                        // eyeSvg.innerHTML = '<path ... ojo abierto ...>';
                    }
                });
            }

            if(toggleConfirmarPassword && confirmarContraseñaInput){
                toggleConfirmarPassword.addEventListener('click', function() {
                    // Alternar el tipo de input entre 'password' y 'text'
                    const type = confirmarContraseñaInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    confirmarContraseñaInput.setAttribute('type', type);

                    // Cambiar el icono del ojo (ahora un SVG en línea)
                    const eyeSvg = this.querySelector('svg');
                    // Alterna el path del ojo abierto/cerrado. Este SVG es solo un ejemplo,
                    // tendrías que ajustar los paths reales para un ojo abierto y un ojo cerrado.
                    // Para simplificar, solo rotaremos el ojo o cambiaremos su opacidad como ejemplo.
                    if (type === 'text') {
                        // Si se muestra la contraseña, podrías cambiar el SVG o su estilo
                        eyeSvg.style.transform = 'scale(0.8)'; // Ejemplo visual
                        eyeSvg.setAttribute('stroke', '#00aaff'); // Cambiar color si se muestra
                        // O si tienes un SVG de ojo cerrado, reemplazarlo
                        // eyeSvg.innerHTML = '<path ... ojo cerrado ...>';
                    } else {
                        // Si la contraseña está oculta
                        eyeSvg.style.transform = 'scale(1)';
                        eyeSvg.setAttribute('stroke', 'currentColor'); // Volver al color original
                        // eyeSvg.innerHTML = '<path ... ojo abierto ...>';
                    }
                });
            }



    // Reemplaza las llamadas a 'alert' con 'showCustomMessage'
    // Ejemplo: alert('Perfil actualizado con éxito.'); se convierte en showCustomMessage('Perfil actualizado con éxito.', 'success');
    // Ejemplo: alert(error.message); se convierte en showCustomMessage(error.message, 'danger');

    // Modifica las funciones para usar el custom message box
    const originalFetch = window.fetch;
    window.fetch = async (...args) => {
        try {
            const response = await originalFetch(...args);
            return response;
        } catch (error) {
            console.error('Fetch Error:', error);
            showCustomMessage('Error de conexión o de red.', 'danger');
            throw error; // Re-lanza el error para que la cadena de promesas pueda manejarlo si es necesario
        }
    };
    </script>
</body>
</html>
