<!DOCTYPE html>
<html lang="es">
<head>
    <title>Editar Perfil</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/bootstrap-icons.css">
    <script src="https://kit.fontawesome.com/a81368914c.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="../css/editar-perfil.css">
</head>
<body>
    <section class="full-box cover dashboard-sideBar">
		<div class="full-box dashboard-sideBar-bg btn-menu-dashboard"></div>
		<div class="full-box dashboard-sideBar-ct">
			<div class="full-box text-uppercase text-center text-titles dashboard-sideBar-title">
				UNEFA <i class="zmdi zmdi-close btn-menu-dashboard visible-xs"></i>
			</div>
			<div class="full-box dashboard-sideBar-UserInfo">
				<figure class="full-box">
					<img src="../assets/img/unefa.png" alt="UserIcon">
					<figcaption class="text-center text-titles" id="sidebarUserName"></figcaption>
				</figure>
				<ul class="full-box list-unstyled text-center">
					<li>
						<a href="/editar-perfil">
							<i class="zmdi zmdi-settings"></i>
						</a>
					</li>
					<li>
						<a href="#" class="btn-exit-system" id="logoutBtn">
							<i class="zmdi zmdi-power"></i>
						</a>
					</li>
				</ul>
			</div>
			<ul class="list-unstyled full-box dashboard-sideBar-Menu">
				<li>
					<a href="/home">
						<i class="zmdi zmdi-view-dashboard zmdi-hc-fw"></i> Dashboard
					</a>
				</li>
				<li>
					<a href="#!" class="btn-sideBar-SubMenu">
						<i class="zmdi zmdi-case zmdi-hc-fw"></i> Administracion <i class="zmdi zmdi-caret-down pull-right"></i>
					</a>
					<ul class="list-unstyled full-box">
						<li>
							<a href="/servicio-comunitario"><i class="zmdi zmdi-accounts"></i> Servicio Comunitario</a>
						</li>
						<li>
							<a href="/trabajo-de-grado"><i class="zmdi zmdi-book zmdi-hc-fw"></i> Trabajo Grado</a>
						</li>
						<li>
							<a href="/proyectos"><i class="zmdi zmdi-graduation-cap zmdi-hc-fw"></i>Proyectos de Investigación</a>
						</li>
						<li>
							<a href="/pasantias"><i class="zmdi zmdi-assignment"></i> Pasantias</a>
						</li>
						<li>
							<a href="/bitacora"><i class="zmdi zmdi-bookmark-outline"></i> Bitácora</a>
						</li>
						<li>
							<a href="/proyectos-eliminados"><i class="zmdi zmdi-delete zmdi-hc-fw"></i> Proyectos Eliminados</a>
						</li>
					</ul>
				</li>
				<li>
					<a href="#!" class="btn-sideBar-SubMenu">
						<i class="zmdi zmdi-account-add zmdi-hc-fw"></i> Usuarios <i class="zmdi zmdi-caret-down pull-right"></i>
					</a>
					<ul class="list-unstyled full-box">
						<li>
							<a href="/admin"><i class="zmdi zmdi-account zmdi-hc-fw"></i> Admin</a>
						</li>
						<li>
							<a href="/tutores"><i class="zmdi zmdi-male-alt zmdi-hc-fw"></i> Tutores</a>
						</li>
						<li>
							<a href="/estudiantes"><i class="zmdi zmdi-face zmdi-hc-fw"></i> Estudiantes</a>
						</li>
					</ul>
				</li>
			</ul>
		</div>
	</section>
    <section class="full-box dashboard-contentPage">
		<nav class="full-box dashboard-Navbar">
			<ul class="full-box list-unstyled text-right">
				<li class="pull-left">
					<a href="#!" class="btn-menu-dashboard"><i class="zmdi zmdi-more-vert"></i></a>
				</li>
			</ul>
            
        </nav>
        <div class="form-container">
            <h2 class="text-center">Editar Perfil</h2>
            <form id="editProfileForm">
                <div class="form-group">
                    <label for="nombre_completo">Nombre Completo</label>
                    <input type="text" class="form-control" id="nombre_completo" name="nombre_completo" required>
                </div>
                <div class="form-group">
                    <label for="correo">Correo Institucional</label>
                    <input type="email" class="form-control" id="correo" name="correo" required>
                </div>
                <div class="form-group">
                    <label for="cedula">Cédula</label>
                    <input type="text" class="form-control" id="cedula" name="cedula" required>
                </div>
                <div class="form-group">
                    <label for="contraseña-antigua">Contraseña Antigua</label>
                    <input type="password" class="form-control" id="contraseña-antigua" name="contraseña-antigua">
                    <span class="toggle-password" id="togglePasswordAntigua">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                    </span>
                </div>
                <div class="form-group">
                    <label for="contraseña">Contraseña</label>
                    <input type="password" class="form-control" id="contraseña" name="contraseña">
                    <span class="toggle-password" id="togglePassword">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                    </span>
                </div>
                <div class="form-group">
                    <label for="confirmar_contraseña">Confirmar contraseña</label>
                    <input type="password" class="form-control" id="confirmar_contraseña" name="confirmar_contraseña">
                    <span class="toggle-password" id="toggleConfirmarPassword">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                    </span>
                </div>
                <div class="text-center">
                    <button type="submit" class="btn btn-primaria id="saveProfileBtn">Guardar Cambios</button>
                    <a href="/home" class="btn btn-default">Cancelar</a>
                </div>
            </form>
        </div>
    </section>

    <div id="customConfirmModal" class="custom-modal-overpal">
        <div class="custom-modal-contenpal">
            <h2>¿Estás seguro?</h2>
            <p>¿Realmente quieres cerrar sesión?</p>
            <div class="custom-modal-botopal">
                <button class="confirm" id="confirmLogoutBtn">Sí, cerrar sesión</button>
                <button class="cancel" id="cancelLogoutBtn">Cancelar</button>
            </div>
        </div>
    </div>

	<script src="../js/jquery-3.1.1.min.js"></script>
	<script src="../js/bootstrap.min.js"></script>
	<script src="../js/material.min.js"></script>
	<script src="../js/ripples.min.js"></script>
	<script src="../js/jquery.mCustomScrollbar.concat.min.js"></script>
	<script src="../js/main.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        let id_login = null;

        try {
            const response = await fetch('/api/current-user-id');
            if (!response.ok) {
                throw new Error('No autorizado. Por favor, inicie sesión de nuevo.');
            }
            const userData = await response.json();
            id_login = userData.id_login;
        } catch (error) {
            console.error('Error:', error);
            const errorMessage = document.createElement('div');
            errorMessage.className = 'alert alert-danger';
            errorMessage.textContent = 'Error al cargar el ID del perfil. Por favor, inicie sesión de nuevo.';
            document.querySelector('.dashboard-contentPage').prepend(errorMessage);

            setTimeout(() => {
                window.location.href = '/'; 
            }, 3000);
            return;
        }
        
        if (!id_login) {
            const errorMessage = document.createElement('div');
            errorMessage.className = 'alert alert-danger';
            errorMessage.textContent = 'ID de usuario no encontrado. Vuelva a iniciar sesión.';
            document.querySelector('.dashboard-contentPage').prepend(errorMessage);

            setTimeout(() => {
                window.location.href = '/'; 
            }, 3000);
            return;
        }
    
            const form = document.getElementById('editProfileForm');
                const saveBtn = document.getElementById('saveProfileBtn');
                
                async function loadUserData() {
                    try {
                        const response = await fetch(`/api/administrador/${id_login}`);
                        if (!response.ok) {
                            throw new Error('Error al cargar los datos del usuario.');
                        }
                        const userData = await response.json();
                        
                        document.getElementById('nombre_completo').value = userData.nombre_completo;
                        document.getElementById('correo').value = userData.correo;
                        document.getElementById('cedula').value = userData.cedula;
            
                    } catch (error) {
                        console.error('Error:', error);
                        const errorMessage = document.createElement('div');
                        errorMessage.className = 'alert alert-danger';
                        errorMessage.textContent = 'Error al cargar los datos del perfil.';
                        document.querySelector('.dashboard-contentPage').prepend(errorMessage);
                    }
                }
                
            
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const nombreCompletoInput = document.getElementById('nombre_completo').value.trim();
            const cedulaInput = document.getElementById('cedula').value.trim();
            const contraseñaNueva = document.getElementById('contraseña').value;
            const confirmarContraseña = document.getElementById('confirmar_contraseña').value;
            const contraseñaAntigua = document.getElementById('contraseña-antigua').value;

            // Validar Nombre Completo (solo letras y espacios)
            const nombreRegex = /^[A-Za-z\sñÑáéíóúÁÉÍÓÚ]+$/;
            if (!nombreRegex.test(nombreCompletoInput)) {
                showCustomMessage('El nombre completo solo debe contener letras y espacios.', 'danger');
                return;
            }

            // Validar Cédula (solo números, 7-10 dígitos)
            const cedulaRegex = /^[0-9]{7,10}$/;
            if (!cedulaRegex.test(cedulaInput)) {
                showCustomMessage('La cédula debe contener solo números y tener entre 7 y 10 dígitos.', 'danger');
                return;
            }

            // Lógica para cambiar contraseña (solo si los campos de contraseña están llenos)
            if (contraseñaNueva || confirmarContraseña || contraseñaAntigua) {
                
                if (contraseñaAntigua === '') {
                    showCustomMessage('Debe ingresar la contraseña antigua para poder cambiarla.', 'danger');
                    return;
                }

                if (contraseñaNueva !== confirmarContraseña) {
                    showCustomMessage('Las contraseñas no coinciden. Por favor, verifica.', 'danger');
                    return;
                }
                
                // Validar Contraseña (mínimo 7 caracteres, 1 mayúscula, 1 minúscula, 1 número, 1 especial)
                const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&._-])[A-Za-z\d@$!%*?&._-]{7,}$/;
                if (!passwordRegex.test(contraseñaNueva)) {
                    showCustomMessage('La contraseña debe tener al menos 7 caracteres, incluyendo una mayúscula, una minúscula, un número y un carácter especial (ej. @$!%*?&._-).', 'danger');
                    return;
                }
            }


            const updatedData = {
                nombre_completo: nombreCompletoInput,
                correo: document.getElementById('correo').value,
                cedula: cedulaInput,
            };

            if (contraseñaNueva) {
                updatedData.contraseña_antigua = contraseñaAntigua;
                updatedData.contraseña_nueva = contraseñaNueva;
            }

            try {
                const response = await fetch(`/api/administrador/${id_login}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedData),
                    credentials: 'include' 
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'No se pudo actualizar el perfil.');
                }
                
                showCustomMessage('Perfil actualizado con éxito.', 'success');
                setTimeout(() => {
                    window.location.href = '/home'; 
                }, 2000);
            } catch (error) {
                console.error('Error:', error);
                showCustomMessage(error.message, 'danger');
            } finally {
                saveBtn.disabled = false;
            }
        });

    
        loadUserData();
    });

    async function fetchWithExponentialBackoff(url, options, retries = 3, delay = 1000) {
    try {
        const response = await fetch(url, options);
        // Manejar respuestas 204 y 304 sin cuerpo
        if (response.status === 204 || response.status === 304) {
            console.log(`Respuesta ${response.status}. Sin contenido para procesar.`);
            return null;
        }
        if (!response.ok) {
            if (response.status === 404) {
                console.warn(`Recurso no encontrado: ${url}`);
                return null;
            }
            throw new Error(`Error HTTP! estado: ${response.status}`);
        }
        return await response.json();
    } catch (error) {
        if (retries > 0) {
            console.warn(`Error en fetch, reintentando en ${delay}ms... (${retries} reintentos restantes)`, error);
            await new Promise(res => setTimeout(res, delay));
            return fetchWithExponentialBackoff(url, options, retries - 1, delay * 2);
        } else {
            console.error('Se agotaron los reintentos. Falló la solicitud:', url, error);
            throw error;
        }
    }
}
    async function loadAuthenticatedUserName(elementId = 'sidebarUserName') {
    const userNameElement = document.getElementById(elementId);
    if (!userNameElement) {
        console.error(`Elemento con ID '${elementId}' no encontrado.`);
        return;
    }
    userNameElement.textContent = 'Cargando...'; // Texto provisional

    try {
        const meResponse = await fetchWithExponentialBackoff(`/api/me`, { method: 'GET', credentials: 'include' });

        if (!meResponse || !meResponse.user || !meResponse.user.id) {
            userNameElement.textContent = 'Usuario Desconocido';
            console.warn('No se pudo obtener el id desde /api/me. Respuesta:', meResponse);
            return;
        }

        const id_login = meResponse.user.id; // 👈 aquí usas "id"



        // 2. Obtener el perfil
        const profileResponse = await fetchWithExponentialBackoff(`/api/user-profile/${id_login}`, { method: 'GET', credentials: 'include' });

        if (profileResponse && profileResponse.nombre_completo) {
            userNameElement.textContent = profileResponse.nombre_completo;
        } else {
            userNameElement.textContent = 'Usuario Desconocido';
        }

    } catch (error) {
        console.error('Error al cargar el nombre del usuario autenticado:', error);
        userNameElement.textContent = 'Error al cargar nombre';
    }
}

    function showCustomMessage(message, type) {
        const messageContainer = document.createElement('div');
        messageContainer.className = `custom-message-box ${type}`;
        messageContainer.innerHTML = `
            <p>${message}</p>
            <button class="close-message-btn">Cerrar</button>
        `;
        document.body.appendChild(messageContainer);

        messageContainer.querySelector('.close-message-btn').addEventListener('click', () => {
            document.body.removeChild(messageContainer);
        });

        const style = document.createElement('style');
        style.textContent = `
            .custom-message-box {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                z-index: 1000;
                text-align: center;
                max-width: 80%;
                border: 2px solid;
            }
            .custom-message-box.success { border-color: rgb(21, 132, 216); color: rgb(21, 132, 216); }
            .custom-message-box.danger { border-color: #2a3e61; color: #2a3e61; }
            .close-message-btn {
                background-color: #007bff;
                color: white;
                border: none;
                padding: 8px 15px;
                border-radius: 5px;
                cursor: pointer;
                margin-top: 15px;
            }
            .close-message-btn:hover {
                background-color: #0056b3;
            }
        `;
        document.head.appendChild(style);
    }
    
    const togglePassword = document.getElementById('togglePassword');
    const toggleConfirmarPassword = document.getElementById('toggleConfirmarPassword');
    const passwordInput = document.getElementById('contraseña');
    const confirmarContraseñaInput = document.getElementById('confirmar_contraseña');
    const toggleAntiguo = document.getElementById('togglePasswordAntigua');
    const antiguoInput = document.getElementById('contraseña-antigua');

    if (togglePassword && passwordInput) {
        togglePassword.addEventListener('click', function() {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
        });
    }

    if(toggleConfirmarPassword && confirmarContraseñaInput){
        toggleConfirmarPassword.addEventListener('click', function() {
            const type = confirmarContraseñaInput.getAttribute('type') === 'password' ? 'text' : 'password';
            confirmarContraseñaInput.setAttribute('type', type);
        });
    }

    if(toggleAntiguo && antiguoInput){
        toggleAntiguo.addEventListener('click', function() {
            const type = antiguoInput.getAttribute('type') === 'password' ? 'text' : 'password';
            antiguoInput.setAttribute('type', type);
        });
    }
    $(document).ready(function() {
        loadAuthenticatedUserName('sidebarUserName');
    });
    </script>
</body>
</html>