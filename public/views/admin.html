<!DOCTYPE html>
<html lang="es">
<head>
	<title>Administradores</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
	<link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/bootstrap-icons.css">
    <link rel="stylesheet" href="../css/admin.css">
</head>
<body>
	<!-- SideBar -->
	<section class="full-box cover dashboard-sideBar">
		<div class="full-box dashboard-sideBar-bg btn-menu-dashboard"></div>
		<div class="full-box dashboard-sideBar-ct">
			<!--SideBar Title -->
			<div class="full-box text-uppercase text-center text-titles dashboard-sideBar-title">
				UNEFA <i class="zmdi zmdi-close btn-menu-dashboard visible-xs"></i>
			</div>
			<!-- SideBar User info -->
			<div class="full-box dashboard-sideBar-UserInfo">
				<figure class="full-box">
					<img src="../assets/img/unefa.png" alt="UserIcon">
					<figcaption class="text-center text-titles" id="sidebarUserName">Cargando...</figcaption>
				</figure>
				<ul class="full-box list-unstyled text-center">
					<li>
						<a href="#!">
							<i class="zmdi zmdi-settings"></i>
						</a>
					</li>
					<li>
						<a href="#" class="btn-exit-system" id="logoutBtn">
							<i class="zmdi zmdi-power"></i>
						</a>
					</li>
				</ul>
			</div>
			<!-- SideBar Menu -->
			<ul class="list-unstyled full-box dashboard-sideBar-Menu">
				<li>
					<a href="/home">
						<i class="zmdi zmdi-view-dashboard zmdi-hc-fw"></i> Dashboard
					</a>
				</li>
				<li>
					<a href="#!" class="btn-sideBar-SubMenu">
						<i class="zmdi zmdi-case zmdi-hc-fw"></i> Administracion <i class="zmdi zmdi-caret-down pull-right"></i>
					</a>
					<ul class="list-unstyled full-box">
						<li>
							<a href="/servicio-comunitario"><i class="zmdi zmdi-accounts"></i> Servicio Comunitario</a>
						</li>
						<li>
							<a href="/trabajo-de-grado"><i class="zmdi zmdi-book zmdi-hc-fw"></i> Trabajo de Grado</a>
						</li>
						<li>
							<a href="/proyectos"><i class="zmdi zmdi-graduation-cap zmdi-hc-fw"></i> Proyectos</a>
						</li>
						<li>
							<a href="/pasantias.html"><i class="zmdi zmdi-assignment"></i> Pasantias</a>
						</li>
                        <li>
							<a href="/bitacora"><i class="zmdi zmdi-bookmark-outline"></i> Bitácora</a>
						</li>
                        <li>
                            <a href="/proyectos-eliminados"><i class="zmdi zmdi-delete zmdi-hc-fw"></i> Proyectos Eliminados</a>
                        </li>
					</ul>
				</li>
				<li>
					<a href="#!" class="btn-sideBar-SubMenu">
						<i class="zmdi zmdi-account-add zmdi-hc-fw"></i> Users <i class="zmdi zmdi-caret-down pull-right"></i>
					</a>
					<ul class="list-unstyled full-box">
						<li>
							<a href="admin.html"><i class="zmdi zmdi-account zmdi-hc-fw"></i> Admin</a>
						</li>
						<li>
							<a href="teacher.html"><i class="zmdi zmdi-male-alt zmdi-hc-fw"></i> Teacher</a>
						</li>
						<li>
							<a href="student.html"><i class="zmdi zmdi-face zmdi-hc-fw"></i> Student</a>
						</li>
					</ul>
				</li>
			</ul>
		</div>
	</section>

	<!-- Content page-->
	<section class="full-box dashboard-contentPage">
		<!-- NavBar -->
		<nav class="full-box dashboard-Navbar">
			<ul class="full-box list-unstyled text-right">
				<li class="pull-left">
					<a href="#!" class="btn-menu-dashboard"><i class="zmdi zmdi-more-vert"></i></a>
				</li>
			</ul>
		</nav>
		<!-- Content page -->
		<div class="container-fluid">
			<div class="page-header" style="text-align: center;">
			  <h1 class="text-titles" style="display: inline-block;">Administradores</h1>
			</div>
			<p class="lead">Bienvenido a la sección de administradores. Aquí puedes gestionar todos los administradores del sistema.</p>
		</div>
		<div class="container-fluid">
			<div class="row">
				<div class="col-xs-12">
					<div id="myTabContent" class="tab-content">
					  	<div class="tab-pane fade active in" id="list">
                            <div class="container-fluid">
                                <div class="row" style="margin-bottom: 15px;">
                                    <div class="col-xs-12 col-sm-6">
                                        <button class="btn btn-info btn-raised" data-toggle="modal" data-target="#addAdminModal" onclick="prepareAddAdminModal()">
                                            <i class="zmdi zmdi-plus"></i> Agregar nuevo administrador
                                        </button>
                                    </div>
                                    <div class="col-xs-12 col-sm-6">
                                        <div class="form-group label-floating">
                                            <label class="control-label" for="searchAdmin">Buscar Administrador</label>
                                            <input class="form-control" type="text" id="searchAdmin" onkeyup="filterTable()">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Tabla para vista de escritorio -->
							<div class="table-responsive">
								<table class="table table-hover text-center table-admins" id="adminTable">
									<thead>
										<tr>
											<th class="text-center">N°</th>
											<th class="text-center">Cédula</th>
											<th class="text-center">Nombre Completo</th>
											<th class="text-center">Correo</th>
											<th class="text-center">Acciones</th>
										</tr>
									</thead>
									<tbody>
										<!-- Los datos se cargarán dinámicamente aquí -->
									</tbody>
								</table>
							</div>

                            <!-- Contenedor para tarjetas en vista móvil -->
                            <div class="mobile-cards-container" id="mobileAdminCards">
                                <!-- Las tarjetas se cargarán dinámicamente aquí para móvil -->
                            </div>

								<ul class="pagination pagination-sm" id="pagination">
								</ul>
					  	</div>
					</div>
				</div>
			</div>
		</div>
	</section>

	<!-- Modal para agregar/editar administrador -->
    <div class="modal fade" tabindex="-1" role="dialog" id="addAdminModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="adminModalTitle">Agregar Nuevo Administrador</h4>
                </div>
                <div class="modal-body">
                    <form id="addAdminForm">
                        <!-- Campo oculto para guardar el ID del administrador si estamos editando -->
                        <input type="hidden" id="editAdminId">

                        <div class="form-group label-floating">
                            <label class="control-label" for="adminCedula">Cédula</label>
                            <input class="form-control" type="text" id="adminCedula" pattern="[0-9]{6,10}" title="La cédula debe contener solo números (6-10 dígitos)" required>
                        </div>
                        <div class="form-group label-floating">
                            <label class="control-label" for="adminNombreCompleto">Nombre Completo</label>
                            <input class="form-control" type="text" id="adminNombreCompleto" pattern="[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+" title="El nombre debe contener solo letras y espacios" required>
                        </div>
                        <div class="form-group label-floating">
                            <label class="control-label" for="adminCorreo">Correo</label>
                            <input class="form-control" type="email" id="adminCorreo" required>
                        </div>
                        <div class="form-group label-floating" id="passwordGroup">
                            <label class="control-label" for="adminPassword">Contraseña (Solo para nuevos administradores)</label>
                            <input class="form-control" type="password" id="adminPassword">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-info btn-raised" id="saveAdminBtn" onclick="saveAdmin()">Guardar Administrador</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ventana modal personalizada (con campo de mensaje para eliminación) -->
    <div id="customAlertModal" class="custom-modal-overlay">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <span id="customAlertTitle"></span>
            </div>
            <div class="custom-modal-body">
                <p id="customAlertMessage"></p>
                <div id="customAlertInputContainer" style="display: none;">
                    <textarea id="customAlertInput" placeholder="Motivo de la eliminación (opcional)"></textarea>
                </div>
            </div>
            <div class="custom-modal-footer">
                <button id="customAlertOkBtn">Ok</button>
                <button id="customAlertCancelBtn" style="display: none; background-color: #f44336; margin-left: 10px;">Cancelar</button>
            </div>
        </div>
    </div>
            <!-- Custom Modal for Confirmation (Alternative to SweetAlert2 if not working) -->
    <div id="customConfirmModal" class="custom-modal-overlag">
        <div class="custom-modal-contento">
            <h2>¿Estás seguro?</h2>
            <p>¿Realmente quieres cerrar sesión?</p>
            <div class="custom-modal-botones">
                <button class="confirm" id="confirmLogoutBtn">Sí, cerrar sesión</button>
                <button class="cancel" id="cancelLogoutBtn">Cancelar</button>
            </div>
        </div>
    </div>
	<!--====== Scripts -->
	<script src="../js/jquery-3.1.1.min.js"></script>
	<script src="../js/bootstrap.min.js"></script>
	<script src="../js/material.min.js"></script>
	<script src="../js/ripples.min.js"></script>
	<script src="../js/jquery.mCustomScrollbar.concat.min.js"></script>
	<script src="../js/main.js"></script>
    <!-- Librerías jsPDF -->
    <script src="../js/jspdf.umd.min.js"></script>
    <script src="../js/jspdf.plugin.autotable.min.js"></script>
	<script type="module" src="../js/obtener-user.js"></script>


<script type="module">
		import { loadAuthenticatedUserName } from '../js/obtener-user.js';
        // Referencias a los elementos de la modal personalizada
        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertTitle = document.getElementById('customAlertTitle');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const customAlertInputContainer = document.getElementById('customAlertInputContainer'); // Contenedor del input
        const customAlertInput = document.getElementById('customAlertInput'); // El input/textarea
        const customAlertOkBtn = document.getElementById('customAlertOkBtn');
        const customAlertCancelBtn = document.getElementById('customAlertCancelBtn'); // Botón de cancelar
        
        // Función para mostrar la modal personalizada
        function showCustomAlert(title, message, showInput = false) {
            customAlertTitle.textContent = title;
            customAlertMessage.textContent = message;
            
            // Mostrar u ocultar el input/textarea
            customAlertInputContainer.style.display = showInput ? 'block' : 'none';
            customAlertInput.value = ''; // Limpiar el campo cada vez
            
            // Mostrar u ocultar el botón de cancelar
            customAlertCancelBtn.style.display = showInput ? 'inline-block' : 'none';

            customAlertModal.style.display = 'flex'; // Usamos flex para centrar

            // Manejo de la promesa para simular .then() de Swal.fire
            return new Promise(resolve => {
                const okClickHandler = function() {
                    customAlertModal.style.display = 'none';
                    customAlertOkBtn.removeEventListener('click', okClickHandler);
                    customAlertCancelBtn.removeEventListener('click', cancelClickHandler);
                    resolve({ isConfirmed: true, inputValue: customAlertInput.value });
                };

                const cancelClickHandler = function() {
                    customAlertModal.style.display = 'none';
                    customAlertOkBtn.removeEventListener('click', okClickHandler);
                    customAlertCancelBtn.removeEventListener('click', cancelClickHandler);
                    resolve({ isConfirmed: false });
                };

                customAlertOkBtn.addEventListener('click', okClickHandler);
                customAlertCancelBtn.addEventListener('click', cancelClickHandler);
            });
        }

        // Para cerrar la modal si se hace clic fuera de ella
        window.onclick = function(event) {
            if (event.target == customAlertModal) {
                customAlertModal.style.display = 'none';
                customAlertOkBtn.removeEventListener('click', okClickHandler); 
                customAlertCancelBtn.removeEventListener('click', cancelClickHandler); 
            }
        };

        const rowsPerPageDesktop = 5;
        const rowsPerPageMobile = 3;
        let currentPage = 1;
        let currentRowsPerPage;

        // Global array to store all administrator data as objects
        let allAdminsData = [];

        // --- Funciones de Utilidad para Fetching ---
        async function fetchWithExponentialBackoff(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    if (response.status === 404) {
                        return null; 
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                if (retries > 0) {
                    console.warn(`Fetch failed, retrying in ${delay}ms... (${retries} retries left)`, error);
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithExponentialBackoff(url, options, retries - 1, delay * 2);
                } else {
                    console.error('Max retries reached. Failed to fetch:', url, error);
                    throw error;
                }
            }
        }

        // Función para cargar datos de la API y poblar la tabla y las tarjetas móviles
        async function loadAdminsFromAPI() {
            try {
                const admins = await fetchWithExponentialBackoff('/api/administradores', { method: 'GET' });
                if (!admins) {
                    await showCustomAlert('Error', 'No se pudieron cargar los administradores. Inténtalo de nuevo más tarde.');
                    return;
                }

                const tableBody = document.getElementById('adminTable').getElementsByTagName('tbody')[0];
                tableBody.innerHTML = ''; // Limpia los datos existentes
                allAdminsData = []; // Limpia el array global

                admins.forEach((admin, index) => {
                    const newOriginalN = index + 1;
                    const newRow = tableBody.insertRow();
                    newRow.dataset.adminId = admin.id_administrador;

                    const cedulaDisplay = admin.cedula ? `<span class="admin-cedula-display">${admin.cedula}</span>` : 'N/A';
                    const nombreCompletoDisplay = admin.nombre_completo ? `<span class="admin-name-display">${admin.nombre_completo}</span>` : 'N/A';
                    const correoDisplay = admin.correo ? `<span class="admin-email-display">${admin.correo}</span>` : 'N/A';

                    newRow.innerHTML = `
                        <td data-label="N°">${newOriginalN}</td>
                        <td data-label="Cédula">${cedulaDisplay}</td>
                        <td data-label="Nombre Completo">${nombreCompletoDisplay}</td>
                        <td data-label="Correo">${correoDisplay}</td>
                        <td data-label="Acciones">
                            <a href="#!" class="btn btn-info btn-raised btn-xs" title="Editar" onclick="openEditAdminModal('${admin.id_administrador}')"><i class="zmdi zmdi-edit"></i></a>
                            <a href="#!" class="btn btn-danger btn-raised btn-xs" title="Eliminar" onclick="confirmDeleteAdmin('${admin.id_administrador}', '${admin.nombre_completo}')"><i class="zmdi zmdi-delete"></i></a>
                            <button class="btn btn-light btn-raised btn-xs" title="Descargar" onclick="handleDownloadAdmin('${admin.id_administrador}')"><i class="zmdi zmdi-download"></i></button>
                        </td>
                    `;

                    allAdminsData.push({
                        element: newRow,
                        originalN: newOriginalN,
                        id_administrador: admin.id_administrador,
                        adminData: admin,
                        searchableText: `${admin.cedula} ${admin.nombre_completo} ${admin.correo}`.toLowerCase(),
                        isVisibleByFilter: true
                    });
                });

                filterTable();
                $.material.init();
            } catch (error) {
                console.error('Error al cargar administradores:', error);
                await showCustomAlert('Error', 'Ocurrió un error al cargar los administradores. Revisa la consola para más detalles.');
            }
        }

        // Función para preparar el modal para agregar un nuevo administrador
        function prepareAddAdminModal() {
            document.getElementById('adminModalTitle').textContent = 'Agregar Nuevo Administrador';
            document.getElementById('saveAdminBtn').textContent = 'Guardar Administrador';
            document.getElementById('editAdminId').value = '';
            document.getElementById('addAdminForm').reset();
            document.getElementById('passwordGroup').style.display = 'block'; // Mostrar campo de contraseña
            document.getElementById('adminPassword').setAttribute('required', 'required'); // Hacer la contraseña requerida
            
            $.material.init(); 
            updateFloatingLabels(); 
        }

        // Función para abrir el modal en modo edición
        async function openEditAdminModal(adminId) {
            document.getElementById('adminModalTitle').textContent = 'Editar Administrador';
            document.getElementById('saveAdminBtn').textContent = 'Guardar Cambios';
            document.getElementById('editAdminId').value = adminId;
            document.getElementById('addAdminForm').reset();
            document.getElementById('passwordGroup').style.display = 'none'; // Ocultar campo de contraseña en edición
            document.getElementById('adminPassword').removeAttribute('required'); // No requerir contraseña en edición
            
            const admin = allAdminsData.find(a => a.id_administrador == adminId)?.adminData;

            if (!admin) {
                await showCustomAlert('Error', 'No se encontró el administrador para editar.');
                return;
            }

            document.getElementById('adminCedula').value = admin.cedula || '';
            document.getElementById('adminNombreCompleto').value = admin.nombre_completo || '';
            document.getElementById('adminCorreo').value = admin.correo || '';

            $.material.init(); 
            updateFloatingLabels(); 
            $('#addAdminModal').modal('show');
        }

        // Function to determine rows per page based on screen width
        function getRowsPerPage() {
            return window.innerWidth <= 767 ? rowsPerPageMobile : rowsPerPageDesktop;
        }

        // Function to apply pagination visibility
        function displayRows() {
            const filteredAdmins = allAdminsData.filter(i => i.isVisibleByFilter);

            // Ocultar todas las filas de la tabla y los cards móviles
            $('.table-admins tbody tr').hide();
            $('#mobileAdminCards').empty(); // Limpiar cards existentes

            currentRowsPerPage = getRowsPerPage();
            const startIndex = (currentPage - 1) * currentRowsPerPage;
            const endIndex = Math.min(startIndex + currentRowsPerPage, filteredAdmins.length);

            if (window.innerWidth <= 767) { // Vista móvil
                $('.table-responsive').hide();
                $('#mobileAdminCards').show();
                for (let i = startIndex; i < endIndex; i++) {
                    if (filteredAdmins[i]) {
                        // Crear y añadir la tarjeta para móvil
                        const admin = filteredAdmins[i].adminData;
                        const card = createMobileAdminCard(admin, i + startIndex + 1); // Pasamos el N° correcto
                        $('#mobileAdminCards').append(card);
                    }
                }
            } else { // Vista de escritorio
                $('.table-responsive').show();
                $('#mobileAdminCards').hide();
                for (let i = startIndex; i < endIndex; i++) {
                    if (filteredAdmins[i]) {
                        filteredAdmins[i].element.style.display = '';
                    }
                }
            }
        }

        // Función para crear una tarjeta de administrador para vista móvil
        function createMobileAdminCard(admin, displayN) {
            const cedulaDisplay = admin.cedula || 'N/A';
            const nombreCompletoDisplay = admin.nombre_completo || 'N/A';
            const correoDisplay = admin.correo || 'N/A';

            return `
                <div class="admin-card" data-admin-id="${admin.id_administrador}">
                    <div class="card-item">
                        <span class="card-label">N°:</span>
                        <span class="card-value">${displayN}</span>
                    </div>
                    <div class="card-item">
                        <span class="card-label">Cédula:</span>
                        <span class="card-value">${cedulaDisplay}</span>
                    </div>
                    <div class="card-item">
                        <span class="card-label">Nombre Completo:</span>
                        <span class="card-value">${nombreCompletoDisplay}</span>
                    </div>
                    <div class="card-item">
                        <span class="card-label">Correo:</span>
                        <span class="card-value">${correoDisplay}</span>
                    </div>
                    <div class="card-actions">
                        <a href="#!" class="btn btn-info btn-raised btn-xs" title="Editar" onclick="openEditAdminModal('${admin.id_administrador}')"><i class="zmdi zmdi-edit"></i></a>
                        <a href="#!" class="btn btn-danger btn-raised btn-xs" title="Eliminar" onclick="confirmDeleteAdmin('${admin.id_administrador}', '${admin.nombre_completo}')"><i class="zmdi zmdi-delete"></i></a>
                        <button class="btn btn-light btn-raised btn-xs" title="Descargar" onclick="handleDownloadAdmin('${admin.id_administrador}')"><i class="zmdi zmdi-download"></i></button>
                    </div>
                </div>
            `;
        }

        // Function to set up pagination links
        function setupPagination() {
            const visibleRowsForPagination = allAdminsData.filter(i => i.isVisibleByFilter);

            const pageCount = Math.ceil(visibleRowsForPagination.length / currentRowsPerPage);
            const paginationUl = document.getElementById('pagination');
            paginationUl.innerHTML = '';

            if (currentPage > pageCount && pageCount > 0) {
                currentPage = pageCount;
            } else if (pageCount === 0 && visibleRowsForPagination.length > 0) {
                currentPage = 1;
            } else if (visibleRowsForPagination.length === 0) {
                currentPage = 1;
            }

            if (pageCount <= 1) {
                paginationUl.style.display = 'none';
            } else {
                paginationUl.style.display = '';
            }

            if (visibleRowsForPagination.length === 0) {
                return;
            }

            let prevLi = document.createElement('li');
            let prevLink = document.createElement('a');
            prevLink.href = '#!';
            prevLink.innerHTML = '«';
            prevLink.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    updateTableAndPagination();
                }
            };
            prevLi.appendChild(prevLink);
            paginationUl.appendChild(prevLi);

            for (let i = 1; i <= pageCount; i++) {
                let li = document.createElement('li');
                let link = document.createElement('a');
                link.href = '#!';
                link.textContent = i;
                link.onclick = (function(pageNumber) {
                    return function() {
                        currentPage = pageNumber;
                        updateTableAndPagination();
                    };
                })(i);
                li.appendChild(link);
                paginationUl.appendChild(li);
            }

            let nextLi = document.createElement('li');
            let nextLink = document.createElement('a');
            nextLink.href = '#!';
            nextLink.innerHTML = '»';
            nextLink.onclick = () => {
                if (currentPage < pageCount) {
                    currentPage++;
                    updateTableAndPagination();
                }
            };
            nextLi.appendChild(nextLink);
            paginationUl.appendChild(nextLi);

            if (currentPage === 1) {
                prevLi.classList.add('disabled');
            } else {
                prevLi.classList.remove('disabled');
            }
            if (currentPage >= pageCount || pageCount === 0) {
                nextLi.classList.add('disabled');
            } else {
                nextLi.classList.remove('disabled');
            }

            Array.from(paginationUl.children).forEach(li => {
                if (li.textContent == currentPage && li.textContent !== '«' && li.textContent !== '»') {
                    li.classList.add('active');
                } else {
                    li.classList.remove('active');
                }
            });
        }

        // Function to update table and pagination
        function updateTableAndPagination() {
            currentRowsPerPage = getRowsPerPage();
            displayRows();
            setupPagination();
        }

        // Function to filter the table
        function filterTable() {
            const input = document.getElementById('searchAdmin');
            const filter = input.value.toLowerCase();
            let currentFilteredN = 1;

            allAdminsData.forEach(admin => {
                if (admin.searchableText.includes(filter)) {
                    admin.isVisibleByFilter = true;
                    if (filter !== '') {
                        admin.element.getElementsByTagName('td')[0].textContent = currentFilteredN++;
                    }
                } else {
                    admin.isVisibleByFilter = false;
                }
            });

            if (filter === '') {
                allAdminsData.forEach((admin) => {
                    admin.element.getElementsByTagName('td')[0].textContent = admin.originalN;
                });
            }

            currentPage = 1;
            updateTableAndPagination();
        }

        // Función para guardar (agregar o editar) un administrador
        async function saveAdmin() {
            const saveButton = document.getElementById('saveAdminBtn');
            saveButton.disabled = true;
            saveButton.textContent = 'Guardando...';

            const adminId = document.getElementById('editAdminId').value;
            const isEditing = !!adminId;

            try {
                const cedula = document.getElementById('adminCedula').value;
                const nombreCompleto = document.getElementById('adminNombreCompleto').value;
                const correo = document.getElementById('adminCorreo').value;
                const password = document.getElementById('adminPassword').value;

                if (!cedula || !nombreCompleto || !correo || (!isEditing && !password)) {
                    await showCustomAlert("Error", "Por favor, completa todos los campos obligatorios.");
                    return;
                }
                
                const adminData = {
                    cedula: cedula,
                    nombre_completo: nombreCompleto,
                    correo: correo
                };

                if (!isEditing) { // Solo añadir contraseña si es un nuevo admin
                    adminData.password = password;
                }

                let response;
                if (isEditing) {
                    response = await fetchWithExponentialBackoff(`/api/administradores/${adminId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(adminData),
                        credentials: 'include'
                    });
                } else {
                    response = await fetchWithExponentialBackoff('/api/administradores', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(adminData),
                        credentials: 'include'
                    });
                }
                
                if (response && response.message) {
                    $('#addAdminModal').on('hidden.bs.modal', async function () {
                        document.getElementById('addAdminForm').reset();
                        $.material.init();
                        await loadAdminsFromAPI();
                        
                        await showCustomAlert("¡Éxito!", response.message);
                        
                        $('.modal-backdrop').remove();
                        $(this).off('hidden.bs.modal'); 
                    });
                    $('#addAdminModal').modal('hide');

                } else {
                    await showCustomAlert("Error", response.error || "No se pudo realizar la operación. Inténtalo de nuevo.");
                }
            } catch (error) {
                console.error('Error al enviar el administrador:', error);
                await showCustomAlert("Error", "Ocurrió un error de conexión al guardar el administrador. Revisa la consola.");
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = isEditing ? 'Guardar Cambios' : 'Guardar Administrador';
            }
        }

        // Function para confirmar la eliminación lógica de un administrador
        async function confirmDeleteAdmin(adminId, adminNombreCompleto) {
            const { isConfirmed, inputValue: mensajeEliminacion } = await showCustomAlert(
                'Confirmar Eliminación', 
                `¿Estás seguro de que quieres eliminar lógicamente al administrador "${adminNombreCompleto}"?`,
                true 
            );

            if (isConfirmed) {
                try {
                    const response = await fetchWithExponentialBackoff(`/api/administradores/eliminar-logico/${adminId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ mensajeEliminacion: mensajeEliminacion }),
                        credentials: 'include'
                    });

                    if (response && response.message) {
                        await showCustomAlert('¡Éxito!', response.message);
                        await loadAdminsFromAPI(); 
                    } else {
                        await showCustomAlert('Error', response.error || 'No se pudo eliminar al administrador lógicamente. Inténtalo de nuevo.');
                    }
                } catch (error) {
                    console.error('Error al eliminar lógicamente al administrador:', error);
                    await showCustomAlert('Error', 'Ocurrió un error de conexión al intentar eliminar al administrador.');
                }
            }
        }

        // --- GENERACIÓN DE PDF EN EL CLIENTE CON JSPDF ---

        // Helper para cargar una imagen y convertirla a Data URL (Base64)
        async function getImageDataUrl(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous'; 
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const canvasResolutionMultiplier = 4; 
                    canvas.width = img.width * canvasResolutionMultiplier;
                    canvas.height = img.height * canvasResolutionMultiplier;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#FFFFFF'; 
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/png'));
                };
                img.onerror = (error) => {
                    console.error('Error al cargar la imagen:', url, error);
                    resolve('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='); 
                };
                img.src = url;
            });
        }

        // Función para descargar los datos de un administrador como PDF
        async function handleDownloadAdmin(adminId) {
            try {
                const adminData = allAdminsData.find(a => a.id_administrador == adminId)?.adminData;

                if (!adminData) {
                    await showCustomAlert('Error', 'No se encontraron los datos del administrador para descargar.');
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const logoUrl = '../assets/img/unefa.png'; // Ruta a tu logo
                const logoDataUrl = await getImageDataUrl(logoUrl);

                // Configurar el documento
                doc.setFontSize(22);
                doc.setTextColor(42, 62, 97); // Color azul oscuro
                doc.text('Reporte de Administrador', doc.internal.pageSize.getWidth() / 2, 30, { align: 'center' });
                
                if (logoDataUrl) {
                    doc.addImage(logoDataUrl, 'PNG', 10, 10, 30, 30);
                }

                doc.setFontSize(12);
                doc.setTextColor(51, 51, 51); // Color gris oscuro
                doc.text(`Fecha de Generación: ${new Date().toLocaleDateString()}`, doc.internal.pageSize.getWidth() - 10, 45, { align: 'right' });

                const startY = 60;
                let currentY = startY;

                // Detalles del Administrador
                doc.setFontSize(14);
                doc.setTextColor(42, 62, 97);
                doc.text('Detalles del Administrador:', 15, currentY);
                currentY += 10;

                doc.setFontSize(12);
                doc.setTextColor(85, 85, 85);

                const adminDetails = [
                    ['ID', adminData.id_administrador],
                    ['Cédula', adminData.cedula],
                    ['Nombre Completo', adminData.nombre_completo],
                    ['Correo', adminData.correo]
                ];

                doc.autoTable({
                    startY: currentY,
                    head: [['Campo', 'Valor']],
                    body: adminDetails,
                    theme: 'grid',
                    styles: { fillColor: [255, 255, 255], textColor: [0, 0, 0], lineWidth: 0.1, lineColor: [200, 200, 200] },
                    headStyles: { fillColor: [42, 62, 97], textColor: [255, 255, 255], fontStyle: 'bold' },
                    columnStyles: { 0: { fontStyle: 'bold' } },
                    margin: { left: 15, right: 15 }
                });

                currentY = doc.autoTable.previous.finalY + 10;


                // Guardar el PDF
                doc.save(`Administrador_${adminData.cedula}.pdf`);

            } catch (error) {
                console.error('Error al generar el PDF del administrador:', error);
                await showCustomAlert('Error', 'Ocurrió un error al generar el PDF. Revisa la consola.');
            }
        }

        function updateFloatingLabels() {
            // Esta función asegura que las etiquetas flotantes de Material Design se comporten correctamente
            $('form .form-group').each(function() {
                if ($(this).find('input').val() !== '') {
                    $(this).addClass('is-focused');
                } else {
                    $(this).removeClass('is-focused');
                }
            });
        }


        // Initial call to populate allAdminsData and display table on load
        $(document).ready(function() {
            loadAuthenticatedUserName();
            loadAdminsFromAPI(); 
            window.addEventListener('resize', updateTableAndPagination);

            // Re-inicializar Material Design cuando el modal se muestra
            $('#addAdminModal').on('shown.bs.modal', function () {
                $.material.init(); 
                updateFloatingLabels(); 
            });
             // Reinicializar Material Design cuando el documento esté listo
            $.material.init();
        });
	</script>
</body>
</html>
