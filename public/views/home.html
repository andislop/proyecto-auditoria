<!DOCTYPE html>
<html lang="es">
<head>
	<title>Inicio</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
	<link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/home.css">
    <style>
        /* Agregamos la fuente Roboto para que coincida con el resto del diseño */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

        body, .modal-content, .custom-modal-content {
            font-family: 'Roboto', sans-serif;
        }

        .modal {
            display: none; /* Oculto por defecto */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 400px;
            position: relative;
            animation-name: animatetop;
            animation-duration: 0.4s;
            text-align: center;
        }
        .custom-modal-overlag {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .custom-modal-overlag.active {
            opacity: 1;
            visibility: visible;
        }
        .custom-modal-overlag.active .custom-modal-content {
            transform: translateY(0);
        }
        @keyframes animatetop {
            from { top: -300px; opacity: 0 }
            to { top: 0; opacity: 1 }
        }

        .modal h2 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .modal p {
            color: #6b7280;
            font-size: 1rem;
        }
                .custom-modal-botones {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .custom-modal-botones button {
            padding: 10px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        .custom-modal-botones button.confirm {
            background-color: #325592; /* Azul para confirmar */
            color: white;
        }

        .custom-modal-botones button.cancel {
            background-color: #ccc; /* Gris para cancelar */
            color: #333;
        }

        .custom-modal-botones button:hover {
            transform: translateY(-2px);
        }
        .custom-modal-contento {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .custom-modal-contento h2 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.5em;
            color: #333;
        }

        .custom-modal-contento p {
            margin-bottom: 25px;
            color: #555;
            line-height: 1.5;
        }

        .custom-modal-botones button.confirm:hover {
            background-color: #2267df;
        }

        .custom-modal-botones button.cancel:hover {
            background-color: #bbb;
        }

        .modal .flex.justify-end.gap-4 {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* Colores y estilos de los botones actualizados */
        .btn-reject {
            background-color: #e0e0e0;
            color: #4a4a4a;
        }
        .btn-reject:hover {
            background-color: #c0c0c0;
        }

        .btn-accept {
            background-color: #007BFF;
            color: white;
        }
        .btn-accept:hover {
            background-color: #0056b3;
        }
        
        /* Estilos generales de los botones */
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .rounded-full { border-radius: 9999px; }
        .transition-colors { transition-property: background-color, border-color, color, fill, stroke; }
        .duration-200 { transition-duration: 200ms; }

        /* Estilos del custom modal para el logout */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s;
            z-index: 1050;
        }
        
        .custom-modal-overlay.active {
            visibility: visible;
            opacity: 1;
        }

        .custom-modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 350px;
        }
        
        .custom-modal-buttons {
            margin-top: 1.5rem;
            display: flex;
            justify-content: space-around;
            gap: 1rem;
        }
        
        .custom-modal-buttons button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .custom-modal-buttons .confirm {
            background-color: #e74c3c;
            color: white;
        }
        
        .custom-modal-buttons .cancel {
            background-color: #bdc3c7;
            color: #333;
        }
        
        .notification-section-title {
            font-size: 1rem;
            font-weight: 500;
            padding: 8px 16px;
            background-color: #f1f1f1;
            border-bottom: 1px solid #e0e0e0;
            text-align: left;
            color: #555;
            text-transform: uppercase;
        }
        .list-group-separator {
            border: 0;
            border-top: 1px solid #e0e0e0;
            margin: 0;
        }
        .reject-action-btn {
            background-color: #e0e0e0;
            color: #4a4a4a;
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            border: none;
            cursor: pointer;
            transition-duration: 200ms;
        }
        .reject-action-btn:hover {
            background-color: #c0c0c0;
        }
    </style>
</head>
<body>
	<!-- SideBar -->
	<section class="full-box cover dashboard-sideBar">
		<div class="full-box dashboard-sideBar-bg btn-menu-dashboard"></div>
		<div class="full-box dashboard-sideBar-ct">
			<!--SideBar Title -->
			<div class="full-box text-uppercase text-center text-titles dashboard-sideBar-title">
				UNEFA <i class="zmdi zmdi-close btn-menu-dashboard visible-xs"></i>
			</div>
			<!-- SideBar User info -->
			<div class="full-box dashboard-sideBar-UserInfo">
				<figure class="full-box">
					<img src="../assets/img/unefa.png" alt="UserIcon">
					<figcaption class="text-center text-titles" id="sidebarUserName"></figcaption>
				</figure>
				<ul class="full-box list-unstyled text-center">
					<li>
						<a href="/editar-perfil">
							<i class="zmdi zmdi-settings"></i>
						</a>
					</li>
					<li>
						<!-- Modificamos el href para que no redirija directamente -->
						<a href="#" class="btn-exit-system" id="logoutBtn">
							<i class="zmdi zmdi-power"></i>
						</a>
					</li>
				</ul>
			</div>
			<!-- SideBar Menu -->
			<ul class="list-unstyled full-box dashboard-sideBar-Menu">
				<li>
					<a href="/home">
						<i class="zmdi zmdi-view-dashboard zmdi-hc-fw"></i> Dashboard
					</a>
				</li>
				<li>
					<a href="#!" class="btn-sideBar-SubMenu">
						<i class="zmdi zmdi-case zmdi-hc-fw"></i> Administracion <i class="zmdi zmdi-caret-down pull-right"></i>
					</a>
					<ul class="list-unstyled full-box">
						<li>
							<a href="/servicio-comunitario"><i class="zmdi zmdi-accounts"></i> Servicio Comunitario</a>
						</li>
						<li>
							<a href="/trabajo-de-grado"><i class="zmdi zmdi-book zmdi-hc-fw"></i> Trabajo Grado</a>
						</li>
						<li>
							<a href="/proyectos"><i class="zmdi zmdi-graduation-cap zmdi-hc-fw"></i>Proyectos de Investigación</a>
						</li>
						<li>
							<a href="/pasantias"><i class="zmdi zmdi-assignment"></i> Pasantias</a>
						</li>
						<li>
							<a href="/bitacora"><i class="zmdi zmdi-bookmark-outline"></i> Bitácora</a>
						</li>
						<li>
							<a href="/proyectos-eliminados"><i class="zmdi zmdi-delete zmdi-hc-fw"></i> Proyectos Eliminados</a>
						</li>
					</ul>
				</li>
				<li>
					<a href="#!" class="btn-sideBar-SubMenu">
						<i class="zmdi zmdi-account-add zmdi-hc-fw"></i> Usuarios <i class="zmdi zmdi-caret-down pull-right"></i>
					</a>
					<ul class="list-unstyled full-box">
						<li>
							<a href="/admin"><i class="zmdi zmdi-account zmdi-hc-fw"></i> Admin</a>
						</li>
						<li>
							<a href="/tutores"><i class="zmdi zmdi-male-alt zmdi-hc-fw"></i> Tutores</a>
						</li>
						<li>
							<a href="/estudiantes"><i class="zmdi zmdi-face zmdi-hc-fw"></i> Estudiantes</a>
						</li>
					</ul>
				</li>
			</ul>
		</div>
	</section>


	<!-- Content page-->
	<section class="full-box dashboard-contentPage">
		<!-- NavBar -->
		<nav class="full-box dashboard-Navbar">
			<ul class="full-box list-unstyled text-right">
				<li class="pull-left">
					<a href="#!" class="btn-menu-dashboard"><i class="zmdi zmdi-more-vert"></i></a>
				</li>
                <li>
					<a href="#!" class="btn-Notifications-area">
						<i class="zmdi zmdi-notifications-none"></i>
						<span class="badge" id="notificationCount"></span>
					</a>
				</li>
			</ul>
		</nav>
		<!-- Content page -->
		<div class="container-fluid">
			<div class="page-header">
			  <h1 class="text-titles">¡Bienvenido!</h1>
			</div>
		</div>
		<div class="full-box text-center" style="padding: 30px 10px;">
            <div class="tiles-container">
                <!-- Servicio Comunitario -->
                <a href="/servicio-comunitario" class="full-box tile">
                    <div class="full-box tile-title text-center text-titles text-uppercase">
                        Servicio Comunitario
                    </div>
                    <div class="full-box tile-icon text-center">
                        <i class="zmdi zmdi-accounts"></i>
                    </div>
                    <div class="full-box tile-number text-titles">
                        <p class="full-box" id="count-servicio-comunitario">0</p>
                        <small>Registrados</small>
                    </div>
                </a>
                <!-- Proyecto de Grado -->
                <a href="/trabajo-de-grado" class="full-box tile">
                    <div class="full-box tile-title text-center text-titles text-uppercase">
                        Proyecto de Grado
                    </div>
                    <div class="full-box tile-icon text-center">
                        <i class="zmdi zmdi-book"></i>
                    </div>
                    <div class="full-box tile-number text-titles">
                        <p class="full-box" id="count-trabajo-de-grado">0</p>
                        <small>Registrados</small>
                    </div>
                </a>
                <!-- Proyectos de Investigación -->
                <a href="/proyectos" class="full-box tile">
                    <div class="full-box tile-title text-center text-titles text-uppercase">
                        Proyectos de Investigación
                    </div>
                    <div class="full-box tile-icon text-center">
                        <i class="zmdi zmdi-graduation-cap"></i>
                    </div>
                    <div class="full-box tile-number text-titles">
                        <p class="full-box" id="count-proyectos-investigacion">0</p>
                        <small>Registrados</small>
                    </div>
                </a>
                <!-- Pasantías -->
                <a href="/pasantias" class="full-box tile">
                    <div class="full-box tile-title text-center text-titles text-uppercase">
                        Pasantías
                    </div>
                    <div class="full-box tile-icon text-center">
                        <i class="zmdi zmdi-assignment"></i> <!-- Icono actualizado -->
                    </div>
                    <div class="full-box tile-number text-titles">
                        <p class="full-box" id="count-pasantias">0</p>
                        <small>Registrados</small>
                    </div>
                </a>
            </div>
		</div>
	</section>
	<!-- Notifications area -->
	<section class="full-box Notifications-area" id="notificationsArea">
		<div class="full-box Notifications-bg btn-Notifications-area"></div>
		<div class="full-box Notifications-body">
			<div class="Notifications-body-title text-titles text-center">
				Notificaciones <i class="zmdi zmdi-close btn-Notifications-area" id="closeNotifications"></i>
			</div>
            <h4 class="notification-section-title">Solicitudes Pendientes</h4>
			<div class="list-group" id="pendingList">
			  	<!-- Solicitudes pendientes se inyectarán aquí -->
			</div>
            <h4 class="notification-section-title mt-4">Usuarios Rechazados</h4>
			<div class="list-group" id="rejectedList">
                <!-- Usuarios rechazados se inyectarán aquí -->
            </div>
		</div>
	</section>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <h2 class="text-lg font-bold mb-4">Solicitud de Acceso</h2>
            <div id="modal-content-data">
                <!-- Data will be injected here -->
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <!-- Se cambian los estilos de los botones a la nueva paleta de colores -->
                <button id="rejectBtn" class="btn-reject font-bold py-2 px-4 rounded-full transition-colors duration-200">Rechazar</button>
                <button id="acceptBtn" class="btn-accept font-bold py-2 px-4 rounded-full transition-colors duration-200">Aceptar</button>
            </div>
        </div>
    </div>
    
    <!-- Reactivation Confirmation Modal -->
    <div id="reactivationModal" class="modal">
        <div class="modal-content">
            <h2 class="text-lg font-bold mb-4">Confirmar Reactivación</h2>
            <div id="reactivation-modal-content">
                <!-- Data will be injected here -->
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="cancelReactivationBtn" class="btn-reject font-bold py-2 px-4 rounded-full transition-colors duration-200">Cancelar</button>
                <button id="confirmReactivationBtn" class="btn-accept font-bold py-2 px-4 rounded-full transition-colors duration-200">Reactivar</button>
            </div>
        </div>
    </div>


    <!-- Custom Modal for Confirmation (Alternative to SweetAlert2 if not working) -->
    <div id="customConfirmModal" class="custom-modal-overlag">
        <div class="custom-modal-contento">
            <h2>¿Estás seguro?</h2>
            <p>¿Realmente quieres cerrar sesión?</p>
            <div class="custom-modal-botones">
                <button class="confirm" id="confirmLogoutBtn">Sí, cerrar sesión</button>
                <button class="cancel" id="cancelLogoutBtn">Cancelar</button>
            </div>
        </div>
    </div>

	<!--====== Scripts -->
	<script src="../js/jquery-3.1.1.min.js"></script>
	<!-- Quitamos SweetAlert2 de aquí si no lo estás usando para otra cosa, o si su lógica de logout está interfiriendo -->
	<!-- <script src="../js/sweetalert2.min.js"></script> -->
	<script src="../js/bootstrap.min.js"></script>
	<script src="../js/material.min.js"></script>
	<script src="../js/ripples.min.js"></script>
	<script src="../js/jquery.mCustomScrollbar.concat.min.js"></script>
	<!-- Es probable que la lógica de cierre de sesión duplicada esté en main.js. -->
	<!-- Si no necesitas otras funcionalidades de main.js o puedes refactorizarlo, -->
	<!-- podrías considerar no cargarlo o modificarlo. Por ahora, dejaremos solo -->
	<!-- la lógica en este archivo para el logout. -->
	<script src="../js/main.js"></script>
	<script>
		$.material.init();
        // user-utils.js

/**
 * Función de utilidad para realizar fetch con retroceso exponencial.
 * @param {string} url - La URL a la que se realizará la solicitud.
 * @param {Object} options - Opciones para la solicitud fetch (método, headers, etc.).
 * @param {number} retries - Número de reintentos en caso de fallo.
 * @param {number} delay - Retraso inicial en milisegundos para el retroceso exponencial.
 * @returns {Promise<Object|null>} - La respuesta JSON de la API o null si falla.
 */
async function fetchWithExponentialBackoff(url, options, retries = 3, delay = 1000) {
    try {
        const response = await fetch(url, options);
        // Manejar respuestas 204 y 304 sin cuerpo
        if (response.status === 204 || response.status === 304) {
            console.log(`Respuesta ${response.status}. Sin contenido para procesar.`);
            return null;
        }
        if (!response.ok) {
            if (response.status === 404) {
                console.warn(`Recurso no encontrado: ${url}`);
                return null;
            }
            throw new Error(`Error HTTP! estado: ${response.status}`);
        }
        return await response.json();
    } catch (error) {
        if (retries > 0) {
            console.warn(`Error en fetch, reintentando en ${delay}ms... (${retries} reintentos restantes)`, error);
            await new Promise(res => setTimeout(res, delay));
            return fetchWithExponentialBackoff(url, options, retries - 1, delay * 2);
        } else {
            console.error('Se agotaron los reintentos. Falló la solicitud:', url, error);
            throw error;
        }
    }
}

/**
 * Carga el nombre del usuario autenticado y lo muestra en el sidebar.
 * Ahora usa /api/me para obtener el id_login y luego /api/user-profile/:id_login
 * para obtener el nombre completo.
 * @param {string} elementId - El ID del elemento HTML donde se mostrará el nombre.
 */
async function loadAuthenticatedUserName(elementId = 'sidebarUserName') {
    const userNameElement = document.getElementById(elementId);
    if (!userNameElement) {
        console.error(`Elemento con ID '${elementId}' no encontrado.`);
        return;
    }
    userNameElement.textContent = 'Cargando...'; // Texto provisional

    try {
        const meResponse = await fetchWithExponentialBackoff(`/api/me`, { method: 'GET', credentials: 'include' });

        if (!meResponse || !meResponse.user || !meResponse.user.id) {
            userNameElement.textContent = 'Usuario Desconocido';
            console.warn('No se pudo obtener el id desde /api/me. Respuesta:', meResponse);
            return;
        }

        const id_login = meResponse.user.id; // 👈 aquí usas "id"



        // 2. Obtener el perfil
        const profileResponse = await fetchWithExponentialBackoff(`/api/user-profile/${id_login}`, { method: 'GET', credentials: 'include' });

        if (profileResponse && profileResponse.nombre_completo) {
            userNameElement.textContent = profileResponse.nombre_completo;
        } else {
            userNameElement.textContent = 'Usuario Desconocido';
        }

    } catch (error) {
        console.error('Error al cargar el nombre del usuario autenticado:', error);
        userNameElement.textContent = 'Error al cargar nombre';
    }
}

        // Función para cargar los conteos dinámicamente
        async function loadDashboardCounts() {
            try {
                // Servicio Comunitario
                const scResponse = await fetchWithExponentialBackoff('/api/dashboard/count/servicio-comunitario');
                $('#count-servicio-comunitario').text(scResponse.count);

                // Trabajo de Grado
                const tgResponse = await fetchWithExponentialBackoff('/api/dashboard/count/trabajo-de-grado');
                $('#count-trabajo-de-grado').text(tgResponse.count);

                // Proyectos de Investigación
                const piResponse = await fetchWithExponentialBackoff('/api/dashboard/count/proyectos-investigacion');
                $('#count-proyectos-investigacion').text(piResponse.count);

                // Pasantías
                const pasResponse = await fetchWithExponentialBackoff('/api/dashboard/count/pasantias');
                $('#count-pasantias').text(pasResponse.count);

            } catch (error) {
                console.error('Error al cargar los conteos del dashboard:', error);
                // Opcional: mostrar un mensaje de error en la UI si es necesario
            }
        }
        // Constantes que referencian los elementos HTML de las notificaciones
const notificationCount = document.getElementById('notificationCount');
const pendingList = document.getElementById('pendingList');
const rejectedList = document.getElementById('rejectedList');
const confirmationModal = document.getElementById('confirmationModal');
const modalContentData = document.getElementById('modal-content-data');
const acceptBtn = document.getElementById('acceptBtn');
const rejectBtn = document.getElementById('rejectBtn');

// Nuevas constantes para el modal de reactivación
const reactivationModal = document.getElementById('reactivationModal');
const reactivationModalContent = document.getElementById('reactivation-modal-content');
const confirmReactivationBtn = document.getElementById('confirmReactivationBtn');
const cancelReactivationBtn = document.getElementById('cancelReactivationBtn');


let selectedUserId = null;

// Función asíncrona principal para obtener y mostrar todos los tipos de usuarios
async function fetchAndRenderAllUsers() {
    // Muestra un estado de carga en el contador
    notificationCount.textContent = '...';
    pendingList.innerHTML = `<div class="p-4 text-center text-gray-500">Cargando solicitudes pendientes...</div>`;
    rejectedList.innerHTML = `<div class="p-4 text-center text-gray-500">Cargando usuarios rechazados...</div>`;

    try {
        const [pendingUsers, rejectedUsers] = await Promise.all([
            fetchWithExponentialBackoff('/api/usuarios_pendientes', { method: 'GET', credentials: 'include' }),
            fetchWithExponentialBackoff('/api/usuarios_rechazados', { method: 'GET', credentials: 'include' })
        ]);

        // Actualiza el contador de notificaciones con la cantidad de usuarios pendientes
        notificationCount.textContent = pendingUsers ? pendingUsers.length : 0;
        
        // Renderiza las solicitudes pendientes
        renderUsers(pendingUsers, pendingList, 'pending');

        // Renderiza los usuarios rechazados
        renderUsers(rejectedUsers, rejectedList, 'rejected');

    } catch (error) {
        console.error('Error al cargar usuarios:', error);
        notificationCount.textContent = 0;
        pendingList.innerHTML = `<div class="p-4 text-center text-red-500">Error al cargar solicitudes pendientes.</div>`;
        rejectedList.innerHTML = `<div class="p-4 text-center text-red-500">Error al cargar usuarios rechazados.</div>`;
    }
}

// Función para renderizar una lista de usuarios en el DOM
function renderUsers(users, listElement, type) {
    listElement.innerHTML = '';
    if (!users || users.length === 0) {
        listElement.innerHTML = `
            <div class="p-4 text-center text-gray-500">
                No hay usuarios en esta categoría.
            </div>
        `;
        return;
    }

    users.forEach((user, index) => {
        const userItem = document.createElement('div');
        userItem.className = 'list-group-item';
        
        const nombre = user.nombre_completo || 'Nombre no disponible';
        const correo = user.correo;
        userItem.dataset.userId = user.id_login;

        let contentHTML;
        if (type === 'pending') {
            contentHTML = `
                <div class="row-action-primary">
                    <i class="zmdi zmdi-account"></i>
                </div>
                <div class="row-content">
                    <h4 class="list-group-item-heading">${nombre}</h4>
                    <p class="list-group-item-text">${correo}</p>
                </div>
            `;
        } else if (type === 'rejected') {
            contentHTML = `
                <div class="row-action-primary">
                    <i class="zmdi zmdi-account"></i>
                </div>
                <div class="row-content">
                    <h4 class="list-group-item-heading">${nombre}</h4>
                    <p class="list-group-item-text">${correo}</p>
                    <div class="mt-2 text-right">
                        <button class="reject-action-btn reactivate-btn">Reactivar</button>
                    </div>
                </div>
            `;
        }

        userItem.innerHTML = contentHTML;
        listElement.appendChild(userItem);

        // Añade un separador si no es el último elemento
        if (index < users.length - 1) {
            const separator = document.createElement('hr');
            separator.className = 'list-group-separator';
            listElement.appendChild(separator);
        }
    });
}

// Función para mostrar el modal de confirmación
function showConfirmationModal(nombre, correo, userId) {
    modalContentData.innerHTML = `
        <h3 class="font-semibold text-lg">${nombre}</h3>
        <p class="text-gray-600">${correo}</p>
        <p class="mt-4">¿Deseas permitir el acceso a este usuario?</p>
    `;
    selectedUserId = userId;
    confirmationModal.style.display = 'flex';
}

// Función para ocultar el modal
function hideConfirmationModal() {
    confirmationModal.style.display = 'none';
    selectedUserId = null;
}

// Manejador de eventos para cerrar el modal al hacer clic fuera de él
window.addEventListener('click', (event) => {
    if (event.target === confirmationModal) {
        hideConfirmationModal();
    }
});

// Manejador de eventos para abrir el modal al hacer clic en una solicitud pendiente
pendingList.addEventListener('click', (event) => {
    const item = event.target.closest('.list-group-item');
    if (item) {
        const userId = item.dataset.userId;
        const nombre = item.querySelector('.list-group-item-heading').textContent;
        const correo = item.querySelector('.list-group-item-text').textContent;
        
        showConfirmationModal(nombre, correo, userId);
    }
});

// Manejador de eventos para los botones del modal
acceptBtn.addEventListener('click', async () => {
    if (selectedUserId) {
        try {
            // Llama a la API para aceptar el usuario usando la nueva ruta
            const response = await fetch(`/api/accept_user/${selectedUserId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                console.log(`Usuario con ID ${selectedUserId} aceptado correctamente.`);
                fetchAndRenderAllUsers(); // Vuelve a cargar todas las listas
            } else {
                console.error('Error al aceptar usuario.');
            }
        } catch (error) {
            console.error('Error de red al aceptar usuario:', error);
        } finally {
            hideConfirmationModal();
        }
    }
});

rejectBtn.addEventListener('click', async () => {
    if (selectedUserId) {
        try {
            // Llama a la API para rechazar el usuario usando la nueva ruta
            const response = await fetch(`/api/reject_user/${selectedUserId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                console.log(`Usuario con ID ${selectedUserId} rechazado correctamente.`);
                fetchAndRenderAllUsers(); // Vuelve a cargar todas las listas
            } else {
                console.error('Error al rechazar usuario.');
            }
        } catch (error) {
            console.error('Error de red al rechazar usuario:', error);
        } finally {
            hideConfirmationModal();
        }
    }
});


// Lógica del nuevo modal de reactivación
const showReactivationModal = (nombre, correo, userId) => {
    reactivationModalContent.innerHTML = `
        <h3 class="font-semibold text-lg">${nombre}</h3>
        <p class="text-gray-600">${correo}</p>
        <p class="mt-4">¿Deseas reactivar a este usuario?</p>
    `;
    selectedUserId = userId;
    reactivationModal.style.display = 'flex';
};

const hideReactivationModal = () => {
    reactivationModal.style.display = 'none';
    selectedUserId = null;
};

// Manejador de eventos para el botón de "Reactivar" en la lista de rechazados
rejectedList.addEventListener('click', (event) => {
    const btn = event.target.closest('.reactivate-btn');
    if (btn) {
        const item = btn.closest('.list-group-item');
        const userId = item.dataset.userId;
        const nombre = item.querySelector('.list-group-item-heading').textContent;
        const correo = item.querySelector('.list-group-item-text').textContent;
        
        showReactivationModal(nombre, correo, userId);
    }
});

// Manejador de eventos para los botones del modal de reactivación
confirmReactivationBtn.addEventListener('click', async () => {
    if (selectedUserId) {
        try {
            // Usa la misma API de aceptar para reactivar
            const response = await fetch(`/api/accept_user/${selectedUserId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                console.log(`Usuario con ID ${selectedUserId} reactivado correctamente.`);
                fetchAndRenderAllUsers(); // Refresca las listas
            } else {
                console.error('Error al reactivar usuario.');
            }
        } catch (error) {
            console.error('Error de red al reactivar usuario:', error);
        } finally {
            hideReactivationModal();
        }
    }
});

cancelReactivationBtn.addEventListener('click', () => {
    hideReactivationModal();
});


		$(document).ready(function() {
            // Configura la carga inicial y la actualización periódica de las notificaciones cada 60 segundos.
            fetchAndRenderAllUsers(); 
            setInterval(fetchAndRenderAllUsers, 60000);
            loadAuthenticatedUserName();
            loadDashboardCounts(); // Cargar los conteos al cargar la página

            // ** Lógica para cerrar sesión **
            const logoutButton = document.getElementById('logoutBtn');
            const customConfirmModal = document.getElementById('customConfirmModal');
            const confirmLogoutBtn = document.getElementById('confirmLogoutBtn');
            const cancelLogoutBtn = document.getElementById('cancelLogoutBtn');

            // Función para mostrar el modal personalizado
            function showCustomConfirmModal() {
                customConfirmModal.classList.add('active');
            }

            // Función para ocultar el modal personalizado
            function hideCustomConfirmModal() {
                customConfirmModal.classList.remove('active');
            }

            // Event listener para el botón de cerrar sesión
            logoutButton.addEventListener('click', function(event) {
                event.preventDefault(); // Evita la redirección inmediata del <a>
                showCustomConfirmModal();
            });

            // Event listener para el botón "Sí, cerrar sesión" del modal
            confirmLogoutBtn.addEventListener('click', async function() {
                hideCustomConfirmModal(); // Oculta el modal

                try {
                    const response = await fetch('/api/logout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        // Si el backend confirma el cierre de sesión, redirige
                        window.location.href = '/'; // Redirige a la página de inicio/login
                    } else {
                        // Manejar errores si el servidor responde con un status diferente de 200
                        const errorData = await response.json();
                        // Si SweetAlert2 no está cargado, usamos el alert nativo.
                        // Lo importante es que aquí ya no hay un Swal.fire para evitar el doble modal
                        console.error('Error al cerrar sesión:', errorData.message);
                        alert('Error al cerrar sesión: ' + (errorData.message || 'Hubo un problema.'));
                    }
                } catch (error) {
                    console.error('Error de red al intentar cerrar sesión:', error);
                    alert('Error de conexión al cerrar sesión. Inténtalo de nuevo.');
                }
            });

            // Event listener para el botón "Cancelar" del modal
            cancelLogoutBtn.addEventListener('click', function() {
                hideCustomConfirmModal(); // Simplemente oculta el modal
            });
        });
	</script>
</body>
</html>
