<!DOCTYPE html>
<html lang="es">
<head>
	<title>Inicio</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
	<link rel="stylesheet" href="../css/main.css">
    <style>
        /* Nuevo estilo para el color azul de la cabecera del tile */
        .tile-title {
            background-color: #4285f4 !important; /* Azul de Google, puedes ajustarlo */
        }

        /* Estilos para el modal personalizado de confirmación (si no usas SweetAlert2) */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .custom-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .custom-modal-content {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .custom-modal-overlay.active .custom-modal-content {
            transform: translateY(0);
        }

        .custom-modal-content h2 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.5em;
            color: #333;
        }

        .custom-modal-content p {
            margin-bottom: 25px;
            color: #555;
            line-height: 1.5;
        }

        .custom-modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .custom-modal-buttons button {
            padding: 10px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        .custom-modal-buttons button.confirm {
            background-color: #f44336; /* Rojo para confirmar */
            color: white;
        }

        .custom-modal-buttons button.cancel {
            background-color: #ccc; /* Gris para cancelar */
            color: #333;
        }

        .custom-modal-buttons button:hover {
            transform: translateY(-2px);
        }

        .custom-modal-buttons button.confirm:hover {
            background-color: #d32f2f;
        }

        .custom-modal-buttons button.cancel:hover {
            background-color: #bbb;
        }
    </style>
</head>
<body>
	<!-- SideBar -->
	<section class="full-box cover dashboard-sideBar">
		<div class="full-box dashboard-sideBar-bg btn-menu-dashboard"></div>
		<div class="full-box dashboard-sideBar-ct">
			<!--SideBar Title -->
			<div class="full-box text-uppercase text-center text-titles dashboard-sideBar-title">
				UNEFA <i class="zmdi zmdi-close btn-menu-dashboard visible-xs"></i>
			</div>
			<!-- SideBar User info -->
			<div class="full-box dashboard-sideBar-UserInfo">
				<figure class="full-box">
					<img src="../assets/img/unefa.png" alt="UserIcon">
					<figcaption class="text-center text-titles">juancito007</figcaption>
				</figure>
				<ul class="full-box list-unstyled text-center">
					<li>
						<a href="#!">
							<i class="zmdi zmdi-settings"></i>
						</a>
					</li>
					<li>
						<!-- Modificamos el href para que no redirija directamente -->
						<a href="#" class="btn-exit-system" id="logoutBtn">
							<i class="zmdi zmdi-power"></i>
						</a>
					</li>
				</ul>
			</div>
			<!-- SideBar Menu -->
			<ul class="list-unstyled full-box dashboard-sideBar-Menu">
				<li>
					<a href="/home">
						<i class="zmdi zmdi-view-dashboard zmdi-hc-fw"></i> Dashboard
					</a>
				</li>
				<li>
					<a href="#!" class="btn-sideBar-SubMenu">
						<i class="zmdi zmdi-case zmdi-hc-fw"></i> Administracion <i class="zmdi zmdi-caret-down pull-right"></i>
					</a>
					<ul class="list-unstyled full-box">
						<li>
							<a href="/servicio-comunitario"><i class="zmdi zmdi-accounts"></i> Servicio Comunitario</a>
						</li>
						<li>
							<a href="/trabajo-de-grado"><i class="zmdi zmdi-book zmdi-hc-fw"></i> Trabajo Grado</a>
						</li>
						<li>
							<a href="/proyectos"><i class="zmdi zmdi-graduation-cap zmdi-hc-fw"></i>Proyectos de Investigación</a>
						</li>
						<li>
							<a href="/pasantias"><i class="zmdi zmdi-assignment"></i> Pasantias</a>
						</li>
						<li>
							<a href="/bitacora"><i class="zmdi zmdi-bookmark-outline"></i> Bitácora</a>
						</li>
						<li>
							<a href="/proyectos-eliminados"><i class="zmdi zmdi-delete zmdi-hc-fw"></i> Proyectos Eliminados</a>
						</li>
					</ul>
				</li>
				<li>
					<a href="#!" class="btn-sideBar-SubMenu">
						<i class="zmdi zmdi-account-add zmdi-hc-fw"></i> Users <i class="zmdi zmdi-caret-down pull-right"></i>
					</a>
					<ul class="list-unstyled full-box">
						<li>
							<a href="admin.html"><i class="zmdi zmdi-account zmdi-hc-fw"></i> Admin</a>
						</li>
						<li>
							<a href="teacher.html"><i class="zmdi zmdi-male-alt zmdi-hc-fw"></i> Teacher</a>
						</li>
						<li>
							<a href="student.html"><i class="zmdi zmdi-face zmdi-hc-fw"></i> Student</a>
						</li>
					</ul>
				</li>
			</ul>
		</div>
	</section>

	<!-- Content page-->
	<section class="full-box dashboard-contentPage">
		<!-- NavBar -->
		<nav class="full-box dashboard-Navbar">
			<ul class="full-box list-unstyled text-right">
				<li class="pull-left">
					<a href="#!" class="btn-menu-dashboard"><i class="zmdi zmdi-more-vert"></i></a>
				</li>
			</ul>
		</nav>
		<!-- Content page -->
		<div class="container-fluid">
			<div class="page-header">
			  <h1 class="text-titles">¡Bienvenido!</h1>
			</div>
		</div>
		<div class="full-box text-center" style="padding: 30px 10px;">
            <div class="tiles-container">
                <!-- Servicio Comunitario -->
                <a href="/servicio-comunitario" class="full-box tile">
                    <div class="full-box tile-title text-center text-titles text-uppercase">
                        Servicio Comunitario
                    </div>
                    <div class="full-box tile-icon text-center">
                        <i class="zmdi zmdi-accounts"></i>
                    </div>
                    <div class="full-box tile-number text-titles">
                        <p class="full-box" id="count-servicio-comunitario">0</p>
                        <small>Registrados</small>
                    </div>
                </a>
                <!-- Proyecto de Grado -->
                <a href="/trabajo-de-grado" class="full-box tile">
                    <div class="full-box tile-title text-center text-titles text-uppercase">
                        Proyecto de Grado
                    </div>
                    <div class="full-box tile-icon text-center">
                        <i class="zmdi zmdi-book"></i>
                    </div>
                    <div class="full-box tile-number text-titles">
                        <p class="full-box" id="count-trabajo-de-grado">0</p>
                        <small>Registrados</small>
                    </div>
                </a>
                <!-- Proyectos de Investigación -->
                <a href="/proyectos" class="full-box tile">
                    <div class="full-box tile-title text-center text-titles text-uppercase">
                        Proyectos de Investigación
                    </div>
                    <div class="full-box tile-icon text-center">
                        <i class="zmdi zmdi-graduation-cap"></i>
                    </div>
                    <div class="full-box tile-number text-titles">
                        <p class="full-box" id="count-proyectos-investigacion">0</p>
                        <small>Registrados</small>
                    </div>
                </a>
                <!-- Pasantías -->
                <a href="/pasantias" class="full-box tile">
                    <div class="full-box tile-title text-center text-titles text-uppercase">
                        Pasantías
                    </div>
                    <div class="full-box tile-icon text-center">
                        <i class="zmdi zmdi-assignment"></i> <!-- Icono actualizado -->
                    </div>
                    <div class="full-box tile-number text-titles">
                        <p class="full-box" id="count-pasantias">0</p>
                        <small>Registrados</small>
                    </div>
                </a>
            </div>
		</div>
	</section>

    <!-- Custom Modal for Confirmation (Alternative to SweetAlert2 if not working) -->
    <div id="customConfirmModal" class="custom-modal-overlay">
        <div class="custom-modal-content">
            <h2>¿Estás seguro?</h2>
            <p>¿Realmente quieres cerrar sesión?</p>
            <div class="custom-modal-buttons">
                <button class="confirm" id="confirmLogoutBtn">Sí, cerrar sesión</button>
                <button class="cancel" id="cancelLogoutBtn">Cancelar</button>
            </div>
        </div>
    </div>

	<!--====== Scripts -->
	<script src="../js/jquery-3.1.1.min.js"></script>
	<!-- Quitamos SweetAlert2 de aquí si no lo estás usando para otra cosa, o si su lógica de logout está interfiriendo -->
	<!-- <script src="../js/sweetalert2.min.js"></script> -->
	<script src="../js/bootstrap.min.js"></script>
	<script src="../js/material.min.js"></script>
	<script src="../js/ripples.min.js"></script>
	<script src="../js/jquery.mCustomScrollbar.concat.min.js"></script>
	<!-- Es probable que la lógica de cierre de sesión duplicada esté en main.js. -->
	<!-- Si no necesitas otras funcionalidades de main.js o puedes refactorizarlo, -->
	<!-- podrías considerar no cargarlo o modificarlo. Por ahora, dejaremos solo -->
	<!-- la lógica en este archivo para el logout. -->
	<script src="../js/main.js"></script>
	<script>
		$.material.init();

        // Función auxiliar para manejar reintentos con backoff exponencial
        async function fetchWithExponentialBackoff(url, options = {}, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                if (retries > 0) {
                    // console.warn(`Intento fallido para ${url}. Reintentando en ${delay / 1000}s...`);
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithExponentialBackoff(url, options, retries - 1, delay * 2);
                } else {
                    throw error;
                }
            }
        }

        // Función para cargar los conteos dinámicamente
        async function loadDashboardCounts() {
            try {
                // Servicio Comunitario
                const scResponse = await fetchWithExponentialBackoff('/api/dashboard/count/servicio-comunitario');
                $('#count-servicio-comunitario').text(scResponse.count);

                // Trabajo de Grado
                const tgResponse = await fetchWithExponentialBackoff('/api/dashboard/count/trabajo-de-grado');
                $('#count-trabajo-de-grado').text(tgResponse.count);

                // Proyectos de Investigación
                const piResponse = await fetchWithExponentialBackoff('/api/dashboard/count/proyectos-investigacion');
                $('#count-proyectos-investigacion').text(piResponse.count);

                // Pasantías
                const pasResponse = await fetchWithExponentialBackoff('/api/dashboard/count/pasantias');
                $('#count-pasantias').text(pasResponse.count);

            } catch (error) {
                console.error('Error al cargar los conteos del dashboard:', error);
                // Opcional: mostrar un mensaje de error en la UI si es necesario
            }
        }

		$(document).ready(function() {
            loadDashboardCounts(); // Cargar los conteos al cargar la página

            // ** Lógica para cerrar sesión **
            const logoutButton = document.getElementById('logoutBtn');
            const customConfirmModal = document.getElementById('customConfirmModal');
            const confirmLogoutBtn = document.getElementById('confirmLogoutBtn');
            const cancelLogoutBtn = document.getElementById('cancelLogoutBtn');

            // Función para mostrar el modal personalizado
            function showCustomConfirmModal() {
                customConfirmModal.classList.add('active');
            }

            // Función para ocultar el modal personalizado
            function hideCustomConfirmModal() {
                customConfirmModal.classList.remove('active');
            }

            // Event listener para el botón de cerrar sesión
            logoutButton.addEventListener('click', function(event) {
                event.preventDefault(); // Evita la redirección inmediata del <a>
                showCustomConfirmModal();
            });

            // Event listener para el botón "Sí, cerrar sesión" del modal
            confirmLogoutBtn.addEventListener('click', async function() {
                hideCustomConfirmModal(); // Oculta el modal

                try {
                    const response = await fetch('/api/logout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        // Si el backend confirma el cierre de sesión, redirige
                        window.location.href = '/'; // Redirige a la página de inicio/login
                    } else {
                        // Manejar errores si el servidor responde con un status diferente de 200
                        const errorData = await response.json();
                        // Si SweetAlert2 no está cargado, usamos el alert nativo.
                        // Lo importante es que aquí ya no hay un Swal.fire para evitar el doble modal
                        console.error('Error al cerrar sesión:', errorData.message);
                        alert('Error al cerrar sesión: ' + (errorData.message || 'Hubo un problema.'));
                    }
                } catch (error) {
                    console.error('Error de red al intentar cerrar sesión:', error);
                    alert('Error de conexión al cerrar sesión. Inténtalo de nuevo.');
                }
            });

            // Event listener para el botón "Cancelar" del modal
            cancelLogoutBtn.addEventListener('click', function() {
                hideCustomConfirmModal(); // Simplemente oculta el modal
            });
        });
	</script>
</body>
</html>
